{% extends "base.html" %}

{% block title %}Talepler - TG Portal{% endblock %}
{% block page_title %}Talepler{% endblock %}

{% block content %}
{% set badge_map = {
  'primary': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
  'success': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
  'warning': 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300',
  'danger':  'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300',
  'info':    'bg-sky-100 text-sky-700 dark:bg-sky-900/30 dark:text-sky-300',
  'secondary':'bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-gray-200',
  'dark':    'bg-gray-200 text-gray-800 dark:bg-white/10 dark:text-gray-200',
  'light':   'bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-gray-200'
} %}

<div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm overflow-hidden">

  <!-- Header / Filtreler -->
  <div class="px-5 py-4 border-b border-border-light dark:border-border-dark">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">

      <form method="GET" class="flex flex-wrap items-center gap-2">
        <!-- Durum -->
        <select name="durum" onchange="this.form.submit()"
                class="rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
          <option value="">Tüm Durumlar</option>
          <option value="acik" {{ 'selected' if request.args.get('durum') == 'acik' }}>Açık</option>
          <option value="atandi" {{ 'selected' if request.args.get('durum') == 'atandi' }}>Atandı</option>
          <option value="devam_ediyor" {{ 'selected' if request.args.get('durum') == 'devam_ediyor' }}>Devam Ediyor</option>
          <option value="beklemede" {{ 'selected' if request.args.get('durum') == 'beklemede' }}>Beklemede</option>
          <option value="cozuldu" {{ 'selected' if request.args.get('durum') == 'cozuldu' }}>Çözüldü</option>
          <option value="kapatildi" {{ 'selected' if request.args.get('durum') == 'kapatildi' }}>Kapatıldı</option>
        </select>

        <!-- Kategori -->
        <select name="kategori_id" onchange="this.form.submit()"
                class="rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
          <option value="">Tüm Kategoriler</option>
          {% for k in kategoriler %}
          <option value="{{ k.id }}" {{ 'selected' if request.args.get('kategori_id')|int == k.id }}>{{ k.ad }}</option>
          {% endfor %}
        </select>

        <!-- Öncelik -->
        <select name="oncelik" onchange="this.form.submit()"
                class="rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
          <option value="">Tüm Öncelikler</option>
          <option value="kritik" {{ 'selected' if request.args.get('oncelik') == 'kritik' }}>Kritik</option>
          <option value="yuksek" {{ 'selected' if request.args.get('oncelik') == 'yuksek' }}>Yüksek</option>
          <option value="normal" {{ 'selected' if request.args.get('oncelik') == 'normal' }}>Normal</option>
          <option value="dusuk" {{ 'selected' if request.args.get('oncelik') == 'dusuk' }}>Düşük</option>
        </select>

        {% if is_destek %}
        <!-- Benim -->
        <label class="inline-flex items-center gap-2 ml-1 text-sm text-text-muted dark:text-text-muted-dark">
          <input type="checkbox" name="benim" value="1"
                 {{ 'checked' if request.args.get('benim') == '1' }}
                 onchange="this.form.submit()"
                 class="w-4 h-4 rounded border-border-light dark:border-border-dark">
          Sadece Benim
        </label>
        {% endif %}
      </form>

      <div class="flex justify-end">
        <a href="{{ url_for('talep.yeni') }}"
           class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-dark">
          <span class="material-symbols-outlined text-[18px]">add</span>
          Yeni Talep
        </a>
      </div>

    </div>
  </div>

  <!-- Liste -->
  {% if talepler %}
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-left text-xs font-bold uppercase tracking-wider text-text-muted dark:text-text-muted-dark bg-gray-50 dark:bg-[#111418]">
          <th class="px-5 py-3">No</th>
          <th class="px-5 py-3">Konu</th>
          <th class="px-5 py-3">Kategori</th>
          {% if is_destek %}<th class="px-5 py-3">Talep Eden</th>{% endif %}
          <th class="px-5 py-3 whitespace-nowrap">Tarih</th>
          <th class="px-5 py-3">Öncelik</th>
          <th class="px-5 py-3">Atanan</th>
          <th class="px-5 py-3">Durum</th>
          <th class="px-5 py-3"></th>
        </tr>
      </thead>

      <tbody class="divide-y divide-border-light dark:divide-border-dark">
        {% for t in talepler %}
        <tr class="hover:bg-gray-50 dark:hover:bg-[#252b36]
                   {{ 'bg-amber-50/70 dark:bg-amber-900/10' if t.sla_asim else '' }}">
          <td class="px-5 py-3">
            <code class="text-xs">{{ t.talep_no }}</code>
          </td>

          <td class="px-5 py-3">
            <a href="{{ url_for('talep.detay', id=t.id) }}"
               class="font-semibold text-[#111418] dark:text-white hover:underline">
              {{ t.konu|truncate(35) }}
            </a>
            {% if t.sla_asim %}
              <span class="inline-flex items-center gap-1 ml-2 text-xs font-semibold text-red-600 dark:text-red-300" title="SLA aşıldı">
                <span class="material-symbols-outlined text-[16px]">schedule</span>
                SLA
              </span>
            {% endif %}
          </td>

          <td class="px-5 py-3">
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold
                         {{ badge_map.get(t.kategori.renk, badge_map['secondary']) }}">
              {{ t.kategori.ad }}
            </span>
          </td>

          {% if is_destek %}
          <td class="px-5 py-3 text-text-muted dark:text-text-muted-dark">
            {{ t.olusturan.full_name }}
          </td>
          {% endif %}

          <td class="px-5 py-3 text-text-muted dark:text-text-muted-dark whitespace-nowrap">
            {{ t.created_at.strftime('%d.%m.%Y %H:%M') }}
          </td>

          <td class="px-5 py-3">
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold
                         {{ badge_map.get(t.oncelik_renk, badge_map['secondary']) }}">
              {{ t.oncelik_text }}
            </span>
          </td>

          <td class="px-5 py-3 text-text-muted dark:text-text-muted-dark">
            {{ t.atanan.full_name if t.atanan else '-' }}
          </td>

          <td class="px-5 py-3">
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold
                         {{ badge_map.get(t.durum_renk, badge_map['secondary']) }}">
              {{ t.durum_text }}
            </span>
          </td>

          <td class="px-5 py-3 text-right">
            <a href="{{ url_for('talep.detay', id=t.id) }}"
               class="inline-flex items-center justify-center w-9 h-9 rounded-lg
                      border border-border-light dark:border-border-dark
                      hover:bg-gray-50 dark:hover:bg-[#252b36]"
               title="Görüntüle">
              <span class="material-symbols-outlined text-[18px]">visibility</span>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if pagination.pages > 1 %}
  <div class="px-5 py-4 border-t border-border-light dark:border-border-dark">
    <nav class="flex justify-center">
      <ul class="flex items-center gap-1">
        {% for p in pagination.iter_pages() %}
          {% if p %}
            {% if p == pagination.page %}
              <li>
                <span class="inline-flex items-center justify-center min-w-9 h-9 px-3 rounded-lg text-sm font-bold
                             bg-primary text-white">
                  {{ p }}
                </span>
              </li>
            {% else %}
              <li>
                <a class="inline-flex items-center justify-center min-w-9 h-9 px-3 rounded-lg text-sm font-semibold
                          border border-border-light dark:border-border-dark
                          hover:bg-gray-50 dark:hover:bg-[#252b36]"
                   href="{{ url_for('talep.liste', page=p, durum=request.args.get('durum'), kategori_id=request.args.get('kategori_id'), oncelik=request.args.get('oncelik'), benim=request.args.get('benim')) }}">
                  {{ p }}
                </a>
              </li>
            {% endif %}
          {% else %}
            <li>
              <span class="inline-flex items-center justify-center min-w-9 h-9 px-3 rounded-lg text-sm font-semibold
                           text-text-muted dark:text-text-muted-dark">
                ...
              </span>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </nav>
  </div>
  {% endif %}

  {% else %}
  <!-- Empty state -->
  <div class="p-10 text-center">
    <div class="mx-auto w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center">
      <span class="material-symbols-outlined text-primary">confirmation_number</span>
    </div>
    <p class="mt-3 text-sm text-text-muted dark:text-text-muted-dark">Talep bulunamadı</p>
  </div>
  {% endif %}
</div>
{% endblock %}
