{% extends "base.html" %}

{% block title %}Destek Talepleri - TG Portal{% endblock %}
{% block page_title %}Destek Talepleri{% endblock %}

{% block content %}

{% set badge_map = {
  'primary': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
  'success': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
  'warning': 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300',
  'danger':  'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300',
  'info':    'bg-sky-100 text-sky-700 dark:bg-sky-900/30 dark:text-sky-300',
  'secondary':'bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-gray-200'
} %}

<!-- İstatistikler -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
  <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm p-5">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-sm text-text-muted dark:text-text-muted-dark">Açık Talepler</p>
        <p class="mt-1 text-3xl font-extrabold tracking-tight text-[#111418] dark:text-white">{{ stats.acik }}</p>
      </div>
      <div class="w-12 h-12 rounded-xl bg-red-500/10 flex items-center justify-center">
        <span class="material-symbols-outlined text-red-600 dark:text-red-300">error</span>
      </div>
    </div>
  </div>

  <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm p-5">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-sm text-text-muted dark:text-text-muted-dark">Çözülen</p>
        <p class="mt-1 text-3xl font-extrabold tracking-tight text-[#111418] dark:text-white">{{ stats.cozuldu }}</p>
      </div>
      <div class="w-12 h-12 rounded-xl bg-green-500/10 flex items-center justify-center">
        <span class="material-symbols-outlined text-green-600 dark:text-green-300">check_circle</span>
      </div>
    </div>
  </div>

  <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm p-5">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-sm text-text-muted dark:text-text-muted-dark">Toplam</p>
        <p class="mt-1 text-3xl font-extrabold tracking-tight text-[#111418] dark:text-white">{{ stats.toplam }}</p>
      </div>
      <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center">
        <span class="material-symbols-outlined text-primary">confirmation_number</span>
      </div>
    </div>
  </div>

  <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm p-5">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-sm text-text-muted dark:text-text-muted-dark">Bugün</p>
        <p class="mt-1 text-3xl font-extrabold tracking-tight text-[#111418] dark:text-white">{{ stats.bugun }}</p>
      </div>
      <div class="w-12 h-12 rounded-xl bg-sky-500/10 flex items-center justify-center">
        <span class="material-symbols-outlined text-sky-600 dark:text-sky-300">calendar_today</span>
      </div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
  <!-- Sol: Hızlı Talep + Kategoriler -->
  <div class="lg:col-span-4 space-y-6">
    <!-- Yeni Talep -->
    <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm overflow-hidden">
      <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">add_circle</span>
        <h2 class="font-bold text-[#111418] dark:text-white">Yeni Talep Oluştur</h2>
      </div>
      <div class="p-5">
        <div class="grid grid-cols-1 gap-2">
          {% for kat in kategoriler %}
          <a href="{{ url_for('talep.yeni') }}?kategori={{ kat.id }}"
             class="w-full inline-flex items-center justify-between gap-3 rounded-xl px-4 py-3
                    border border-border-light dark:border-border-dark
                    hover:bg-gray-50 dark:hover:bg-[#252b36] transition">
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl
                           {{ badge_map.get(kat.renk, badge_map['secondary']) }}">
                <span class="material-symbols-outlined text-[20px]">category</span>
              </span>
              <span class="font-semibold text-[#111418] dark:text-white">{{ kat.ad }}</span>
            </div>
            <span class="material-symbols-outlined text-text-muted dark:text-text-muted-dark">chevron_right</span>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>

    {% if is_destek %}
      {% if atanmamis %}
      <!-- Atanmamış Talepler -->
      <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm overflow-hidden">
        <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-red-600 dark:text-red-300">report</span>
            <h2 class="font-bold text-[#111418] dark:text-white">Atanmamış</h2>
          </div>
          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold {{ badge_map['danger'] }}">
            {{ atanmamis|length }}
          </span>
        </div>

        <div class="divide-y divide-border-light dark:divide-border-dark">
          {% for t in atanmamis[:5] %}
          <a href="{{ url_for('talep.detay', id=t.id) }}"
             class="block px-5 py-3 hover:bg-gray-50 dark:hover:bg-[#252b36] transition">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold text-[#111418] dark:text-white truncate">{{ t.konu|truncate(25) }}</div>
                <div class="text-xs text-text-muted dark:text-text-muted-dark mt-1">
                  {{ t.talep_no }} - {{ t.olusturan.full_name }}
                </div>
              </div>
              <span class="shrink-0 inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold
                           {{ badge_map.get(t.oncelik_renk, badge_map['secondary']) }}">
                {{ t.oncelik_text }}
              </span>
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if bana_atanan %}
      <!-- Bana Atananlar -->
      <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm overflow-hidden">
        <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">person_check</span>
            <h2 class="font-bold text-[#111418] dark:text-white">Bana Atanan</h2>
          </div>
          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold {{ badge_map['primary'] }}">
            {{ bana_atanan|length }}
          </span>
        </div>

        <div class="divide-y divide-border-light dark:divide-border-dark">
          {% for t in bana_atanan[:5] %}
          <a href="{{ url_for('talep.detay', id=t.id) }}"
             class="block px-5 py-3 hover:bg-gray-50 dark:hover:bg-[#252b36] transition">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold text-[#111418] dark:text-white truncate">{{ t.konu|truncate(25) }}</div>
                <div class="text-xs text-text-muted dark:text-text-muted-dark mt-1">
                  {{ t.talep_no }}
                </div>
              </div>
              <span class="shrink-0 inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold
                           {{ badge_map.get(t.durum_renk, badge_map['secondary']) }}">
                {{ t.durum_text }}
              </span>
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    {% endif %}
  </div>

  <!-- Sağ: Son Talepler -->
  <div class="lg:col-span-8">
    <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm overflow-hidden">
      <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-primary">history</span>
          <h2 class="font-bold text-[#111418] dark:text-white">{{ 'Son Talepler' if is_destek else 'Taleplerim' }}</h2>
        </div>
        <a href="{{ url_for('talep.liste') }}"
           class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-semibold
                  border border-border-light dark:border-border-dark
                  text-text-muted dark:text-text-muted-dark hover:bg-gray-50 dark:hover:bg-[#252b36]">
          Tümü <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
        </a>
      </div>

      {% if son_talepler %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-xs font-bold uppercase tracking-wider text-text-muted dark:text-text-muted-dark bg-gray-50 dark:bg-[#111418]">
              <th class="px-5 py-3">No</th>
              <th class="px-5 py-3">Konu</th>
              <th class="px-5 py-3">Kategori</th>
              {% if is_destek %}<th class="px-5 py-3">Talep Eden</th>{% endif %}
              <th class="px-5 py-3">Öncelik</th>
              <th class="px-5 py-3">Durum</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border-light dark:divide-border-dark">
            {% for t in son_talepler %}
            <tr class="cursor-pointer hover:bg-gray-50 dark:hover:bg-[#252b36]"
                onclick="window.location='{{ url_for('talep.detay', id=t.id) }}'">
              <td class="px-5 py-3"><code class="text-xs">{{ t.talep_no }}</code></td>
              <td class="px-5 py-3 font-semibold text-[#111418] dark:text-white">{{ t.konu|truncate(30) }}</td>
              <td class="px-5 py-3">
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold
                             {{ badge_map.get(t.kategori.renk, badge_map['secondary']) }}">
                  {{ t.kategori.ad }}
                </span>
              </td>
              {% if is_destek %}<td class="px-5 py-3 text-text-muted dark:text-text-muted-dark">{{ t.olusturan.full_name }}</td>{% endif %}
              <td class="px-5 py-3">
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold
                             {{ badge_map.get(t.oncelik_renk, badge_map['secondary']) }}">
                  {{ t.oncelik_text }}
                </span>
              </td>
              <td class="px-5 py-3">
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold
                             {{ badge_map.get(t.durum_renk, badge_map['secondary']) }}">
                  {{ t.durum_text }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="p-10 text-center text-sm text-text-muted dark:text-text-muted-dark">
        Henüz talep yok
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
