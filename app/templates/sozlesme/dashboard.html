{% extends "base.html" %}

{% block title %}Sözleşme Yönetimi - TG Portal{% endblock %}
{% block page_title %}Sözleşme Yönetimi{% endblock %}

{% block content %}

{# Renk map’leri (modelden gelen s.kalan_gun_renk / s.durum_renk gibi değerleri Tailwind’e çeviriyoruz) #}
{% set badge_map = {
  'primary': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
  'success': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
  'warning': 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300',
  'danger':  'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300',
  'info':    'bg-sky-100 text-sky-700 dark:bg-sky-900/30 dark:text-sky-300',
  'secondary':'bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-gray-200',
  'dark':    'bg-gray-200 text-gray-800 dark:bg-white/10 dark:text-gray-200',
  'light':   'bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-gray-200'
} %}

{% set stat_map = {
  'primary': 'border-blue-500/40 bg-white dark:bg-card-dark',
  'success': 'border-green-500/40 bg-white dark:bg-card-dark',
  'warning': 'border-amber-500/40 bg-white dark:bg-card-dark',
  'danger':  'border-red-500/40 bg-white dark:bg-card-dark'
} %}

<!-- İstatistikler -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
  <!-- Toplam -->
  <div class="rounded-2xl border border-border-light dark:border-border-dark p-5 shadow-sm {{ stat_map['primary'] }}">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-sm text-text-muted dark:text-text-muted-dark">Toplam</p>
        <p class="mt-1 text-3xl font-extrabold tracking-tight text-[#111418] dark:text-white">{{ stats.toplam }}</p>
      </div>
      <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center">
        <span class="material-symbols-outlined text-primary">description</span>
      </div>
    </div>
  </div>

  <!-- Aktif -->
  <div class="rounded-2xl border border-border-light dark:border-border-dark p-5 shadow-sm {{ stat_map['success'] }}">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-sm text-text-muted dark:text-text-muted-dark">Aktif</p>
        <p class="mt-1 text-3xl font-extrabold tracking-tight text-[#111418] dark:text-white">{{ stats.aktif }}</p>
      </div>
      <div class="w-12 h-12 rounded-xl bg-green-500/10 flex items-center justify-center">
        <span class="material-symbols-outlined text-green-600 dark:text-green-300">check_circle</span>
      </div>
    </div>
  </div>

  <!-- 30 gün -->
  <div class="rounded-2xl border border-border-light dark:border-border-dark p-5 shadow-sm {{ stat_map['warning'] }}">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-sm text-text-muted dark:text-text-muted-dark">30 Gün İçinde</p>
        <p class="mt-1 text-3xl font-extrabold tracking-tight text-[#111418] dark:text-white">{{ stats.yaklasan_30 }}</p>
      </div>
      <div class="w-12 h-12 rounded-xl bg-amber-500/10 flex items-center justify-center">
        <span class="material-symbols-outlined text-amber-600 dark:text-amber-300">schedule</span>
      </div>
    </div>
  </div>

  <!-- 7 gün -->
  <div class="rounded-2xl border border-border-light dark:border-border-dark p-5 shadow-sm {{ stat_map['danger'] }}">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-sm text-text-muted dark:text-text-muted-dark">7 Gün İçinde</p>
        <p class="mt-1 text-3xl font-extrabold tracking-tight text-[#111418] dark:text-white">{{ stats.yaklasan_7 }}</p>
      </div>
      <div class="w-12 h-12 rounded-xl bg-red-500/10 flex items-center justify-center">
        <span class="material-symbols-outlined text-red-600 dark:text-red-300">warning</span>
      </div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Sol: Yaklaşan Bitiş Tarihleri -->
  <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm overflow-hidden">
    <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">alarm</span>
        <h2 class="font-bold text-[#111418] dark:text-white">Bitiş Tarihi Yaklaşan</h2>
      </div>
      <a href="{{ url_for('sozlesme.liste') }}?durum=aktif"
         class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-semibold
                border border-border-light dark:border-border-dark
                text-text-muted dark:text-text-muted-dark hover:bg-gray-50 dark:hover:bg-[#252b36]">
        Tümü
        <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
      </a>
    </div>

    {% if yaklasan %}
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left text-xs font-bold uppercase tracking-wider text-text-muted dark:text-text-muted-dark bg-gray-50 dark:bg-[#111418]">
            <th class="px-5 py-3">Sözleşme</th>
            <th class="px-5 py-3">Taraf</th>
            <th class="px-5 py-3 whitespace-nowrap">Bitiş</th>
            <th class="px-5 py-3 whitespace-nowrap">Kalan</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border-light dark:divide-border-dark">
          {% for s in yaklasan[:10] %}
          <tr class="cursor-pointer hover:bg-gray-50 dark:hover:bg-[#252b36]"
              onclick="window.location='{{ url_for('sozlesme.detay', id=s.id) }}'">
            <td class="px-5 py-3 font-semibold text-[#111418] dark:text-white">{{ s.baslik|truncate(25) }}</td>
            <td class="px-5 py-3 text-text-muted dark:text-text-muted-dark">{{ s.taraf_adi|truncate(20) }}</td>
            <td class="px-5 py-3 text-text-muted dark:text-text-muted-dark whitespace-nowrap">{{ s.bitis_tarihi.strftime('%d.%m.%Y') }}</td>
            <td class="px-5 py-3 whitespace-nowrap">
              {% set kalan_cls = badge_map.get(s.kalan_gun_renk, badge_map['secondary']) %}
              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold {{ kalan_cls }}">
                {{ s.kalan_gun }} gün
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="p-10 text-center">
      <div class="mx-auto w-12 h-12 rounded-2xl bg-green-500/10 flex items-center justify-center">
        <span class="material-symbols-outlined text-green-600 dark:text-green-300">task_alt</span>
      </div>
      <p class="mt-3 text-sm text-text-muted dark:text-text-muted-dark">Yaklaşan bitiş tarihi yok</p>
    </div>
    {% endif %}
  </div>

  <!-- Sağ: Tip Dağılımı + Hızlı İşlemler -->
  <div class="space-y-6">
    <!-- Tip Dağılımı -->
    <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm">
      <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">pie_chart</span>
        <h2 class="font-bold text-[#111418] dark:text-white">Tip Dağılımı</h2>
      </div>

      <div class="p-5">
        {% if tip_dagilim %}
        <div class="space-y-3">
          {% for tip, adet in tip_dagilim %}
          <div class="flex items-center justify-between">
            <span class="text-[#111418] dark:text-white font-medium">{{ tip }}</span>
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold {{ badge_map['secondary'] }}">
              {{ adet }}
            </span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-sm text-text-muted dark:text-text-muted-dark">Henüz sözleşme yok</p>
        {% endif %}
      </div>
    </div>

    <!-- Hızlı İşlemler -->
    <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm">
      <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">bolt</span>
        <h2 class="font-bold text-[#111418] dark:text-white">Hızlı İşlemler</h2>
      </div>

      <div class="p-5 space-y-3">
        <a href="{{ url_for('sozlesme.ekle') }}"
           class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl
                  bg-primary text-white font-bold hover:bg-primary-dark transition">
          <span class="material-symbols-outlined">add</span>
          Yeni Sözleşme
        </a>

        <a href="{{ url_for('sozlesme.liste') }}"
           class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl
                  border border-border-light dark:border-border-dark
                  text-[#111418] dark:text-white font-semibold
                  hover:bg-gray-50 dark:hover:bg-[#252b36] transition">
          <span class="material-symbols-outlined">list</span>
          Tüm Sözleşmeler
        </a>

        {% if current_user.has_permission('sozlesme.admin') %}
        <a href="{{ url_for('sozlesme.tip_liste') }}"
           class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl
                  border border-border-light dark:border-border-dark
                  text-[#111418] dark:text-white font-semibold
                  hover:bg-gray-50 dark:hover:bg-[#252b36] transition">
          <span class="material-symbols-outlined">sell</span>
          Sözleşme Tipleri
        </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Son Eklenen -->
<div class="mt-6 rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm overflow-hidden">
  <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex items-center gap-2">
    <span class="material-symbols-outlined text-primary">history</span>
    <h2 class="font-bold text-[#111418] dark:text-white">Son Eklenen Sözleşmeler</h2>
  </div>

  {% if son_eklenen %}
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-left text-xs font-bold uppercase tracking-wider text-text-muted dark:text-text-muted-dark bg-gray-50 dark:bg-[#111418]">
          <th class="px-5 py-3">Sözleşme</th>
          <th class="px-5 py-3">Tip</th>
          <th class="px-5 py-3">Taraf</th>
          <th class="px-5 py-3 whitespace-nowrap">Süre</th>
          <th class="px-5 py-3 whitespace-nowrap">Tutar</th>
          <th class="px-5 py-3">Durum</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-border-light dark:divide-border-dark">
        {% for s in son_eklenen %}
        <tr class="cursor-pointer hover:bg-gray-50 dark:hover:bg-[#252b36]"
            onclick="window.location='{{ url_for('sozlesme.detay', id=s.id) }}'">
          <td class="px-5 py-3 font-semibold text-[#111418] dark:text-white">{{ s.baslik|truncate(30) }}</td>
          <td class="px-5 py-3">
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold {{ badge_map['secondary'] }}">
              {{ s.tip.ad if s.tip else '-' }}
            </span>
          </td>
          <td class="px-5 py-3 text-text-muted dark:text-text-muted-dark">{{ s.taraf_adi|truncate(25) }}</td>
          <td class="px-5 py-3 text-text-muted dark:text-text-muted-dark whitespace-nowrap">
            {{ s.baslangic_tarihi.strftime('%d.%m.%Y') }} - {{ s.bitis_tarihi.strftime('%d.%m.%Y') }}
          </td>
          <td class="px-5 py-3 text-[#111418] dark:text-white whitespace-nowrap">
            {% if s.tutar %}
              {% if s.para_birimi == 'TRY' %}₺{% elif s.para_birimi == 'USD' %}${% elif s.para_birimi == 'EUR' %}€{% endif %}{{ "%.2f"|format(s.tutar) }}
            {% else %}
              <span class="text-text-muted dark:text-text-muted-dark">-</span>
            {% endif %}
          </td>
          <td class="px-5 py-3">
            {% set durum_cls = badge_map.get(s.durum_renk, badge_map['secondary']) %}
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold {{ durum_cls }}">
              {{ s.durum_text }}
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="p-10 text-center">
    <p class="text-sm text-text-muted dark:text-text-muted-dark">Henüz sözleşme eklenmemiş</p>
  </div>
  {% endif %}
</div>

{% endblock %}
