{% extends "base.html" %}

{% block title %}{{ 'Sözleşme Düzenle' if sozlesme else 'Yeni Sözleşme' }} - TG Portal{% endblock %}
{% block page_title %}{{ 'Sözleşme Düzenle' if sozlesme else 'Yeni Sözleşme' }}{% endblock %}

{% block content %}
<form method="POST" enctype="multipart/form-data">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Sol -->
    <div class="lg:col-span-8 space-y-6">
      <!-- Sözleşme Bilgileri -->
      <div class="bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-2xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-border-light dark:border-border-dark">
          <div class="font-bold">Sözleşme Bilgileri</div>
        </div>

        <div class="p-6 grid grid-cols-1 md:grid-cols-12 gap-4">
          <div class="md:col-span-8">
            <label class="block text-sm font-medium mb-1">Sözleşme Adı *</label>
            <input type="text" name="baslik" required
                   value="{{ sozlesme.baslik if sozlesme else '' }}"
                   placeholder="Örn: 2024 Yılı Hizmet Sözleşmesi"
                   class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
          </div>

          <div class="md:col-span-4">
            <label class="block text-sm font-medium mb-1">Sözleşme No</label>
            <input type="text" name="sozlesme_no"
                   value="{{ sozlesme.sozlesme_no if sozlesme else '' }}"
                   placeholder="Örn: SZL-2024-001"
                   class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
          </div>

          <div class="md:col-span-6">
            <label class="block text-sm font-medium mb-1">Sözleşme Tipi *</label>
            <select name="tip_id" required class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
              <option value="">Seçin.</option>
              {% for t in tipler %}
              <option value="{{ t.id }}" {{ 'selected' if sozlesme and sozlesme.tip_id == t.id }}>{{ t.ad }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="md:col-span-6">
            <label class="block text-sm font-medium mb-1">Sorumlu Kişi</label>
            <select name="sorumlu_id" class="select2 w-full">
              <option value="">Seçin.</option>
              {% for c in calisanlar %}
              <option value="{{ c.id }}" {{ 'selected' if sozlesme and sozlesme.sorumlu_id == c.id }}>{{ c.ad_soyad }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="md:col-span-12">
            <label class="block text-sm font-medium mb-1">Açıklama</label>
            <textarea name="aciklama" rows="2"
                      class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm"
                      placeholder="Kısa açıklama...">{{ sozlesme.aciklama if sozlesme else '' }}</textarea>
          </div>
        </div>
      </div>

      <!-- Taraf -->
      <div class="bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-2xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-border-light dark:border-border-dark">
          <div class="font-bold">Taraf Bilgileri</div>
        </div>

        <div class="p-6 grid grid-cols-1 md:grid-cols-12 gap-4">
          <div class="md:col-span-6">
            <label class="block text-sm font-medium mb-1">Taraf Tipi *</label>
            <select id="tarafTipi" name="taraf_tipi" required class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
              <option value="musteri" {{ 'selected' if sozlesme and sozlesme.musteri_id }}>Müşteri</option>
              <option value="tedarikci" {{ 'selected' if sozlesme and sozlesme.tedarikci_id }}>Tedarikçi</option>
              <option value="diger" {{ 'selected' if sozlesme and (not sozlesme.musteri_id and not sozlesme.tedarikci_id) }}>Diğer</option>
            </select>
          </div>

          <div id="musteriDiv" class="md:col-span-6">
            <label class="block text-sm font-medium mb-1">Müşteri *</label>
            <select name="musteri_id" class="select2 w-full">
              <option value="">Seçin.</option>
              {% for m in musteriler %}
              <option value="{{ m.id }}" {{ 'selected' if sozlesme and sozlesme.musteri_id == m.id }}>{{ m.ad }}</option>
              {% endfor %}
            </select>
          </div>

          <div id="tedarikciDiv" class="md:col-span-6">
            <label class="block text-sm font-medium mb-1">Tedarikçi *</label>
            <select name="tedarikci_id" class="select2 w-full">
              <option value="">Seçin.</option>
              {% for t in tedarikciler %}
              <option value="{{ t.id }}" {{ 'selected' if sozlesme and sozlesme.tedarikci_id == t.id }}>{{ t.ad }}</option>
              {% endfor %}
            </select>
          </div>

          <div id="digerDiv" class="md:col-span-6">
            <label class="block text-sm font-medium mb-1">Diğer Taraf *</label>
            <input type="text" name="diger_taraf" value="{{ sozlesme.diger_taraf if sozlesme else '' }}"
                   placeholder="Taraf adı"
                   class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
          </div>
        </div>
      </div>

      <!-- Tarih ve Yenileme -->
      <div class="bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-2xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-border-light dark:border-border-dark">
          <div class="font-bold">Tarih ve Yenileme</div>
        </div>

        <div class="p-6 grid grid-cols-1 md:grid-cols-12 gap-4">
          <div class="md:col-span-4">
            <label class="block text-sm font-medium mb-1">Başlangıç *</label>
            <input type="date" name="baslangic_tarihi" required
                   value="{{ sozlesme.baslangic_tarihi.strftime('%Y-%m-%d') if sozlesme else '' }}"
                   class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
          </div>

          <div class="md:col-span-4">
            <label class="block text-sm font-medium mb-1">Bitiş *</label>
            <input type="date" name="bitis_tarihi" required
                   value="{{ sozlesme.bitis_tarihi.strftime('%Y-%m-%d') if sozlesme else '' }}"
                   class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
          </div>

          <div class="md:col-span-4">
            <label class="block text-sm font-medium mb-1">İmza Tarihi</label>
            <input type="date" name="imza_tarihi"
                   value="{{ sozlesme.imza_tarihi.strftime('%Y-%m-%d') if sozlesme and sozlesme.imza_tarihi else '' }}"
                   class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
          </div>

          <div class="md:col-span-6 flex items-center gap-2 pt-2">
            <input type="checkbox" id="otomatikYenileme" name="otomatik_yenileme"
                   class="rounded border-border-light dark:border-border-dark"
                   {{ 'checked' if sozlesme and sozlesme.otomatik_yenileme }}>
            <label for="otomatikYenileme" class="text-sm">Otomatik Yenileme</label>
          </div>

          <div class="md:col-span-6">
            <label class="block text-sm font-medium mb-1">Yenileme Süresi (Ay)</label>
            <input type="number" name="yenileme_suresi_ay" min="1" max="120"
                   value="{{ sozlesme.yenileme_suresi_ay if sozlesme else 12 }}"
                   class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
          </div>
        </div>
      </div>

      <!-- Tutar -->
      <div class="bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-2xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-border-light dark:border-border-dark">
          <div class="font-bold">Tutar Bilgileri</div>
        </div>

        <div class="p-6 grid grid-cols-1 md:grid-cols-12 gap-4">
          <div class="md:col-span-5">
            <label class="block text-sm font-medium mb-1">Tutar</label>
            <div class="flex">
              <input type="text" name="tutar" value="{{ sozlesme.tutar if sozlesme else '' }}" placeholder="0.00"
                     class="w-full rounded-l-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
              <select name="para_birimi"
                      class="rounded-r-lg border-l-0 border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm w-24">
                <option value="TRY" {{ 'selected' if not sozlesme or sozlesme.para_birimi == 'TRY' }}>₺</option>
                <option value="USD" {{ 'selected' if sozlesme and sozlesme.para_birimi == 'USD' }}>$</option>
                <option value="EUR" {{ 'selected' if sozlesme and sozlesme.para_birimi == 'EUR' }}>€</option>
              </select>
            </div>
          </div>

          <div class="md:col-span-4">
            <label class="block text-sm font-medium mb-1">Ödeme Periyodu</label>
            <select name="odeme_periyodu" class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
              <option value="">Seçin.</option>
              <option value="tek_seferlik" {{ 'selected' if sozlesme and sozlesme.odeme_periyodu == 'tek_seferlik' }}>Tek Seferlik</option>
              <option value="aylik" {{ 'selected' if sozlesme and sozlesme.odeme_periyodu == 'aylik' }}>Aylık</option>
              <option value="yillik" {{ 'selected' if sozlesme and sozlesme.odeme_periyodu == 'yillik' }}>Yıllık</option>
            </select>
          </div>

          <div class="md:col-span-3 flex items-center gap-2 pt-7">
            <input type="checkbox" id="kdvDahil" name="kdv_dahil" class="rounded border-border-light dark:border-border-dark"
                   {{ 'checked' if not sozlesme or sozlesme.kdv_dahil }}>
            <label for="kdvDahil" class="text-sm">KDV Dahil</label>
          </div>
        </div>
      </div>

      <!-- Özel Şartlar -->
      <div class="bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-2xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-border-light dark:border-border-dark">
          <div class="font-bold">Özel Şartlar ve Notlar</div>
        </div>

        <div class="p-6 grid grid-cols-1 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Özel Şartlar</label>
            <textarea name="ozel_sartlar" rows="3" placeholder="Sözleşmeye özgü özel şartlar."
                      class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">{{ sozlesme.ozel_sartlar if sozlesme else '' }}</textarea>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Notlar</label>
            <textarea name="notlar" rows="2" placeholder="Dahili notlar."
                      class="w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">{{ sozlesme.notlar if sozlesme else '' }}</textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Sağ -->
    <div class="lg:col-span-4 space-y-6">
      <!-- Dosya -->
      <div class="bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-2xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-border-light dark:border-border-dark">
          <div class="font-bold">Sözleşme Dosyası</div>
        </div>
        <div class="p-6">
          {% if sozlesme and sozlesme.dosya_yolu %}
          <div class="rounded-xl bg-gray-50 dark:bg-[#111418] border border-border-light dark:border-border-dark p-4 text-center">
            <div class="mx-auto mb-2 inline-flex h-12 w-12 items-center justify-center rounded-full bg-red-50 dark:bg-red-900/20">
              <span class="material-symbols-outlined">picture_as_pdf</span>
            </div>
            <div class="text-sm font-medium mb-2">{{ sozlesme.dosya_adi }}</div>
            <a href="{{ url_for('sozlesme.dosya_indir', id=sozlesme.id) }}"
               class="inline-flex items-center gap-2 rounded-lg border border-border-light dark:border-border-dark px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-[#252b36]">
              <span class="material-symbols-outlined">download</span> İndir
            </a>
          </div>

          <div class="mt-4 text-sm text-text-muted dark:text-text-muted-dark">Yeni dosya yükleyin:</div>
          {% endif %}

          <input type="file" name="dosya" accept=".pdf,doc,docx,jpg,jpeg,png"
                 class="mt-2 w-full rounded-lg border border-border-light dark:border-border-dark bg-white dark:bg-[#111418] px-3 py-2 text-sm">
          <div class="mt-1 text-xs text-text-muted dark:text-text-muted-dark">PDF, DOC, DOCX, JPG, PNG</div>
        </div>
      </div>

      <!-- Kaydet -->
      <div class="bg-white dark:bg-card-dark border border-border-light dark:border-border-dark rounded-2xl shadow-sm">
        <div class="p-6 space-y-2">
          <button type="submit"
                  class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary-dark">
            <span class="material-symbols-outlined">check</span> {{ 'Güncelle' if sozlesme else 'Kaydet' }}
          </button>

          <a href="{{ url_for('sozlesme.dashboard') }}"
             class="w-full inline-flex items-center justify-center gap-2 rounded-lg border border-border-light dark:border-border-dark px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-[#252b36]">
            <span class="material-symbols-outlined">close</span> İptal
          </a>
        </div>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function() {
    function showTarafDiv() {
      var tip = $('#tarafTipi').val();
      $('#musteriDiv, #tedarikciDiv, #digerDiv').hide();

      if (tip === 'musteri') $('#musteriDiv').show();
      else if (tip === 'tedarikci') $('#tedarikciDiv').show();
      else $('#digerDiv').show();
    }

    $('#tarafTipi').change(showTarafDiv);
    showTarafDiv();
  });
</script>
{% endblock %}
