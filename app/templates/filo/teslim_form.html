{% extends "base.html" %}

{% block title %}Araç {{ 'Teslim' if islem_tipi == 'teslim' else 'İade' }} - {{ arac.plaka }} - TG Portal{% endblock %}
{% block page_title %}Araç {{ 'Teslim' if islem_tipi == 'teslim' else 'İade' }} Formu{% endblock %}

{% block extra_css %}
<style>
    .signature-pad {
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        background: #fff;
    }
</style>
{% endblock %}

{% block content %}
<form method="POST" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Sol: Araç Bilgileri -->
        <div class="space-y-4">
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
                <div class="{% if islem_tipi == 'teslim' %}bg-green-600{% else %}bg-yellow-500{% endif %} text-white px-4 py-3 rounded-t-xl">
                    <h6 class="font-medium flex items-center gap-2">
                        <span class="material-symbols-outlined">{% if islem_tipi == 'teslim' %}logout{% else %}login{% endif %}</span><!--</span>
                        Araç Bilgileri
                    </h6>
                </div>
                <div class="p-4">
                    <table class="w-full text-sm">
                        <tr>
                            <td class="text-text-muted dark:text-text-muted-dark py-1 w-24">Plaka</td>
                            <td class="py-1 font-semibold">{{ arac.plaka }}</td>
                        </tr>
                        <tr>
                            <td class="text-text-muted dark:text-text-muted-dark py-1">Araç</td>
                            <td class="py-1">{{ arac.marka }} {{ arac.model }}</td>
                        </tr>
                        <tr>
                            <td class="text-text-muted dark:text-text-muted-dark py-1">Renk</td>
                            <td class="py-1">{{ arac.renk or '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-text-muted dark:text-text-muted-dark py-1">Mevcut KM</td>
                            <td class="py-1">{{ arac.km|default(0) }} km</td>
                        </tr>
                        {% if arac.atanan_calisan %}
                        <tr>
                            <td class="text-text-muted dark:text-text-muted-dark py-1">Zimmetli</td>
                            <td class="py-1">{{ arac.atanan_calisan.full_name }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
            
            {% if islem_tipi == 'iade' and son_teslim %}
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
                <div class="px-4 py-3 border-b border-border-light dark:border-border-dark bg-gray-50 dark:bg-[#111418]">
                    <h6 class="font-medium text-[#111418] dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined">history</span>Son Teslim Bilgisi
                    </h6>
                </div>
                <div class="p-4">
                    <div class="text-sm text-text-muted dark:text-text-muted-dark">
                        Teslim: {{ son_teslim.tarih.strftime('%d.%m.%Y %H:%M') }}<br>
                        KM: {{ son_teslim.km }}<br>
                        Yakıt: {{ son_teslim.yakit_durumu_display }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Sağ: Form -->
        <div class="lg:col-span-2 space-y-4">
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
                <div class="px-4 py-3 border-b border-border-light dark:border-border-dark">
                    <h6 class="font-medium text-[#111418] dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined">speed</span>Temel Bilgiler
                    </h6>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-[#111418] dark:text-white mb-1">Kilometre *</label>
                            <input type="number" name="km" class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required value="{{ arac.km or 0 }}" min="{{ arac.km or 0 }}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#111418] dark:text-white mb-1">Yakıt Durumu *</label>
                            <select name="yakit_durumu" class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Seçin...</option>
                                <option value="dolu">Dolu</option>
                                <option value="uc_ceyrek">3/4</option>
                                <option value="yarim">1/2</option>
                                <option value="ceyrek">1/4</option>
                                <option value="bos">Boş</option>
                            </select>
                        </div>
                    </div>
                    
                    {% if islem_tipi == 'teslim' %}
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-[#111418] dark:text-white mb-1">Teslim Alan Çalışan *</label>
                        <select name="teslim_alan_calisan_id" class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="">Seçin...</option>
                            {% for calisan in calisanlar %}
                            <option value="{{ calisan.id }}">{{ calisan.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Aksesuarlar -->
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
                <div class="px-4 py-3 border-b border-border-light dark:border-border-dark">
                    <h6 class="font-medium text-[#111418] dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined">inventory_2</span>Aksesuarlar
                    </h6>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        {% for key, label in aksesuarlar.items() %}
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="aksesuarlar" value="{{ key }}" class="w-4 h-4 text-blue-600 border-border-light dark:border-border-dark rounded focus:ring-blue-500" id="aks_{{ key }}" checked>
                            <span class="text-sm">{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Hasar Durumu -->
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
                <div class="px-4 py-3 border-b border-border-light dark:border-border-dark">
                    <h6 class="font-medium text-[#111418] dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined">warning</span>Hasar Durumu
                    </h6>
                </div>
                <div class="p-4">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-[#111418] dark:text-white mb-1">Mevcut Hasarlar</label>
                        <textarea name="mevcut_hasarlar" class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="Varsa mevcut hasarları belirtin..."></textarea>
                    </div>
                    
                    {% if islem_tipi == 'iade' %}
                    <label class="flex items-center gap-2 cursor-pointer mb-3">
                        <input type="checkbox" name="yeni_hasar" class="w-4 h-4 text-rose-600 border-border-light dark:border-border-dark rounded focus:ring-red-500" id="yeniHasar" onchange="document.getElementById('yeniHasarAciklama').classList.toggle('hidden')">
                        <span class="text-rose-600 font-semibold">Yeni hasar tespit edildi</span>
                    </label>
                    <div id="yeniHasarAciklama" class="hidden">
                        <textarea name="yeni_hasar_aciklama" class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="Yeni hasar açıklaması..."></textarea>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Fotoğraflar -->
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
                <div class="px-4 py-3 border-b border-border-light dark:border-border-dark">
                    <h6 class="font-medium text-[#111418] dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined">photo_camera</span>Fotoğraflar
                    </h6>
                </div>
                <div class="p-4">
                    <input type="file" name="fotograflar" class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" multiple accept="image/*">
                    <p class="text-xs text-text-muted dark:text-text-muted-dark mt-1">Araç fotoğrafları (çoklu seçim yapabilirsiniz)</p>
                </div>
            </div>
            
            <!-- İmzalar -->
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
                <div class="px-4 py-3 border-b border-border-light dark:border-border-dark">
                    <h6 class="font-medium text-[#111418] dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined">edit</span>İmzalar
                    </h6>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-[#111418] dark:text-white mb-1">Teslim Eden İmza</label>
                            <canvas id="signatureTeslimEden" class="signature-pad w-full" height="150"></canvas>
                            <input type="hidden" name="imza_teslim_eden" id="imzaTeslimEden">
                            <button type="button" class="mt-2 px-3 py-1 text-sm border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg hover:bg-gray-50 dark:hover:bg-[#252b36] dark:bg-[#111418]" onclick="clearSignature('TeslimEden')">Temizle</button>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[#111418] dark:text-white mb-1">Teslim Alan İmza</label>
                            <canvas id="signatureTeslimAlan" class="signature-pad w-full" height="150"></canvas>
                            <input type="hidden" name="imza_teslim_alan" id="imzaTeslimAlan">
                            <button type="button" class="mt-2 px-3 py-1 text-sm border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg hover:bg-gray-50 dark:hover:bg-[#252b36] dark:bg-[#111418]" onclick="clearSignature('TeslimAlan')">Temizle</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notlar -->
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
                <div class="px-4 py-3 border-b border-border-light dark:border-border-dark">
                    <h6 class="font-medium text-[#111418] dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined">sticky_note_2</span>Notlar
                    </h6>
                </div>
                <div class="p-4">
                    <textarea name="notlar" class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="Ek notlar..."></textarea>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 {% if islem_tipi == 'teslim' %}bg-green-600 hover:bg-green-700{% else %}bg-yellow-500 hover:bg-yellow-600{% endif %} text-white font-medium rounded-lg transition-colors">
                    <span class="material-symbols-outlined">check</span>{{ 'Teslim Et' if islem_tipi == 'teslim' else 'İade Al' }}
                </button>
                <a href="{{ url_for('filo.detay', id=arac.id) }}" class="inline-flex items-center gap-2 px-4 py-2 border border-gray-300 text-[#111418] dark:text-white font-medium rounded-lg hover:bg-gray-50 dark:hover:bg-[#252b36] transition-colors">İptal</a>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
// İmza pad'leri
var signaturePadTeslimEden = new SignaturePad(document.getElementById('signatureTeslimEden'));
var signaturePadTeslimAlan = new SignaturePad(document.getElementById('signatureTeslimAlan'));

function clearSignature(type) {
    if (type === 'TeslimEden') {
        signaturePadTeslimEden.clear();
    } else {
        signaturePadTeslimAlan.clear();
    }
}

// Form submit öncesi imzaları kaydet
document.querySelector('form').addEventListener('submit', function() {
    if (!signaturePadTeslimEden.isEmpty()) {
        document.getElementById('imzaTeslimEden').value = signaturePadTeslimEden.toDataURL();
    }
    if (!signaturePadTeslimAlan.isEmpty()) {
        document.getElementById('imzaTeslimAlan').value = signaturePadTeslimAlan.toDataURL();
    }
});
</script>
{% endblock %}
