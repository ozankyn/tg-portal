{% extends "base.html" %}

{% block title %}Trafik Cezası - {{ ceza.arac.plaka }} - TG Portal{% endblock %}
{% block page_title %}Trafik Cezası Detayı{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-exclamation-octagon me-2"></i>
                    {{ ceza.arac.plaka }} - {{ ceza.ceza_turu or 'Trafik Cezası' }}
                </h6>
                <span class="badge bg-{{ 'success' if ceza.durum == 'odendi' else ('warning' if ceza.durum == 'bekliyor' else 'info') }}">
                    {{ ceza.durum|upper }}
                </span>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr><td class="text-muted">Araç</td><td><a href="{{ url_for('filo.detay', id=ceza.arac_id) }}">{{ ceza.arac.plaka }}</a></td></tr>
                            <tr><td class="text-muted">Sürücü</td><td>{{ ceza.surucu.full_name if ceza.surucu else '-' }}</td></tr>
                            <tr><td class="text-muted">Ceza Tarihi</td><td><strong>{{ ceza.ceza_tarihi.strftime('%d.%m.%Y %H:%M') }}</strong></td></tr>
                            <tr><td class="text-muted">Konum</td><td>{{ ceza.konum or '-' }}</td></tr>
                            <tr><td class="text-muted">Tutanak No</td><td>{{ ceza.tutanak_no or '-' }}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr><td class="text-muted">Ceza Tutarı</td><td><strong class="text-danger fs-5">{{ "%.2f"|format(ceza.ceza_tutari) }} ₺</strong></td></tr>
                            {% if ceza.indirimli_tutar %}
                            <tr><td class="text-muted">İndirimli Tutar</td><td><strong class="text-success">{{ "%.2f"|format(ceza.indirimli_tutar) }} ₺</strong></td></tr>
                            {% endif %}
                            <tr><td class="text-muted">Ceza Puanı</td><td>{{ ceza.ceza_puani or 0 }} puan</td></tr>
                            <tr><td class="text-muted">Tebliğ Tarihi</td><td>{{ ceza.teblig_tarihi.strftime('%d.%m.%Y') if ceza.teblig_tarihi else '-' }}</td></tr>
                            <tr><td class="text-muted">Son Ödeme</td><td>
                                {% if ceza.son_odeme_tarihi %}
                                <span class="{{ 'text-danger fw-bold' if ceza.gecikme_durumu == 'gecikti' else '' }}">
                                    {{ ceza.son_odeme_tarihi.strftime('%d.%m.%Y') }}
                                </span>
                                {% else %}
                                -
                                {% endif %}
                            </td></tr>
                        </table>
                    </div>
                </div>
                
                {% if ceza.aciklama %}
                <h6><i class="bi bi-file-text me-2"></i>Açıklama</h6>
                <p>{{ ceza.aciklama }}</p>
                {% endif %}
                
                {% if ceza.durum == 'odendi' %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>Ödendi:</strong> {{ ceza.odeme_tarihi.strftime('%d.%m.%Y') if ceza.odeme_tarihi else '' }} - {{ "%.2f"|format(ceza.odenen_tutar) if ceza.odenen_tutar else '' }} ₺
                </div>
                {% endif %}
                
                {% if ceza.surucuye_yansitildi %}
                <div class="alert alert-info">
                    <i class="bi bi-person-check me-2"></i>
                    <strong>Sürücüye Yansıtıldı:</strong> {{ ceza.yansitma_tarihi.strftime('%d.%m.%Y') if ceza.yansitma_tarihi else '' }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        {% if ceza.durum == 'bekliyor' %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-credit-card me-2"></i>Ödeme Yap</h6>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('filo.ceza_ode', id=ceza.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label class="form-label">Ödeme Tarihi *</label>
                        <input type="date" name="odeme_tarihi" class="form-control" required value="{{ today().strftime('%Y-%m-%d') if today else '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ödenen Tutar (₺)</label>
                        <input type="number" name="odenen_tutar" class="form-control" step="0.01" value="{{ ceza.indirimli_tutar or ceza.ceza_tutari }}">
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check-lg me-1"></i>Ödendi Olarak İşaretle
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
        
        {% if ceza.surucu and not ceza.surucuye_yansitildi %}
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-person-dash me-2"></i>Sürücüye Yansıt</h6>
            </div>
            <div class="card-body">
                <p class="small text-muted">Bu cezayı {{ ceza.surucu.full_name }} adlı sürücüye yansıtmak istiyor musunuz?</p>
                <form method="POST" action="{{ url_for('filo.ceza_yansit', id=ceza.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-warning w-100">
                        <i class="bi bi-person-check me-1"></i>Sürücüye Yansıt
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-3">
    <a href="{{ url_for('filo.ceza_liste') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Listeye Dön
    </a>
</div>
{% endblock %}
