{% extends "base.html" %}

{% block title %}{{ materyal.ad }} - TG Portal{% endblock %}
{% block page_title %}{{ materyal.ad }}{% endblock %}

{% block extra_css %}
<style>
    .viewer-container {
        background: #1a1a2e;
        border-radius: 0.75rem;
        overflow: hidden;
        min-height: 70vh;
    }
    .viewer-frame {
        width: 100%;
        height: 75vh;
        border: none;
    }
    .video-container {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
    }
    .video-container iframe,
    .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="mb-4">
    <ol class="flex items-center gap-2 text-sm">
        <li><a href="{{ url_for('egitim.liste') }}" class="text-text-muted dark:text-text-muted-dark hover:text-primary">Eğitimler</a></li>
        <li class="text-text-muted dark:text-text-muted-dark">/</li>
        <li><a href="{{ url_for('egitim.detay', id=materyal.egitim_id) }}" class="text-text-muted dark:text-text-muted-dark hover:text-primary">{{ materyal.egitim.baslik }}</a></li>
        <li class="text-text-muted dark:text-text-muted-dark">/</li>
        <li class="text-[#111418] dark:text-white font-medium">{{ materyal.ad }}</li>
    </ol>
</nav>

<div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm overflow-hidden">
    <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
        <div class="flex items-center gap-2">
            {% if materyal.materyal_tipi == 'video' %}
            <span class="material-symbols-outlined text-rose-500">play_circle</span>
            {% elif materyal.materyal_tipi == 'sunum' %}
            <span class="material-symbols-outlined text-amber-500">slideshow</span>
            {% elif materyal.materyal_tipi == 'gorsel' %}
            <span class="material-symbols-outlined text-cyan-500">image</span>
            {% elif materyal.materyal_tipi == 'link' %}
            <span class="material-symbols-outlined text-blue-500">link</span>
            {% else %}
            <span class="material-symbols-outlined text-gray-500">description</span>
            {% endif %}
            <div>
                <strong class="text-[#111418] dark:text-white">{{ materyal.ad }}</strong>
                {% if materyal.aciklama %}
                <span class="text-text-muted dark:text-text-muted-dark text-sm ml-2">- {{ materyal.aciklama }}</span>
                {% endif %}
            </div>
        </div>
        <div class="flex gap-2">
            {% if materyal.dosya_yolu %}
            <a href="{{ url_for('egitim.materyal_indir', id=materyal.id) }}" class="px-3 py-1.5 border border-primary text-primary hover:bg-primary/10 font-medium text-sm rounded-lg transition-colors flex items-center gap-1">
                <span class="material-symbols-outlined text-lg">download</span>İndir
            </a>
            {% endif %}
            {% if materyal.harici_link %}
            <a href="{{ materyal.harici_link }}" target="_blank" class="px-3 py-1.5 border border-primary text-primary hover:bg-primary/10 font-medium text-sm rounded-lg transition-colors flex items-center gap-1">
                <span class="material-symbols-outlined text-lg">open_in_new</span>Yeni Sekme
            </a>
            {% endif %}
            <a href="{{ url_for('egitim.detay', id=materyal.egitim_id) }}" class="px-3 py-1.5 border border-border-light dark:border-border-dark hover:bg-gray-50 dark:hover:bg-[#252b36] font-medium text-sm rounded-lg transition-colors flex items-center gap-1">
                <span class="material-symbols-outlined text-lg">arrow_back</span>Geri
            </a>
        </div>
    </div>
    
    <div>
        {% set ext = materyal.dosya_adi.rsplit('.', 1)[1].lower() if materyal.dosya_adi and '.' in materyal.dosya_adi else '' %}
        
        {# PDF #}
        {% if ext == 'pdf' %}
        <div class="viewer-container">
            <iframe src="{{ url_for('egitim.materyal_embed', id=materyal.id) }}" class="viewer-frame" title="{{ materyal.ad }}"></iframe>
        </div>
        
        {# Office #}
        {% elif ext in ['ppt', 'pptx', 'doc', 'docx', 'xls', 'xlsx'] %}
        <div class="py-16 text-center bg-gray-50 dark:bg-[#111418]">
            <span class="material-symbols-outlined text-6xl text-amber-500 mb-4">slideshow</span>
            <h5 class="text-lg font-bold text-[#111418] dark:text-white mb-2">{{ materyal.dosya_adi }}</h5>
            <p class="text-text-muted dark:text-text-muted-dark mb-6">Office dosyaları şu an doğrudan görüntülenemiyor.<br>Lütfen indirip bilgisayarınızda açın.</p>
            <a href="{{ url_for('egitim.materyal_indir', id=materyal.id) }}" class="inline-flex items-center gap-2 px-6 py-3 bg-primary hover:bg-primary-dark text-white font-bold rounded-lg transition-colors">
                <span class="material-symbols-outlined">download</span>Dosyayı İndir
            </a>
            <p class="text-text-muted dark:text-text-muted-dark text-sm mt-4">
                <strong>Boyut:</strong> {{ (materyal.dosya_boyut / 1024 / 1024)|round(2) }} MB
            </p>
        </div>
        
        {# Video #}
        {% elif ext in ['mp4', 'webm'] %}
        <div class="viewer-container p-4">
            <div class="video-container">
                <video controls autoplay>
                    <source src="{{ url_for('egitim.materyal_embed', id=materyal.id) }}" type="{{ materyal.mime_type }}">
                    Tarayıcınız video oynatmayı desteklemiyor.
                </video>
            </div>
        </div>
        
        {# Görsel #}
        {% elif ext in ['jpg', 'jpeg', 'png', 'gif'] %}
        <div class="p-8 text-center bg-gray-50 dark:bg-[#111418]">
            <img src="{{ url_for('egitim.materyal_embed', id=materyal.id) }}" alt="{{ materyal.ad }}" class="max-w-full max-h-[70vh] mx-auto rounded-lg shadow-lg">
        </div>
        
        {# Harici Link #}
        {% elif materyal.harici_link %}
            {% set link = materyal.harici_link %}
            
            {# YouTube #}
            {% if 'youtube.com' in link or 'youtu.be' in link %}
                {% set video_id = link.split('v=')[1].split('&')[0] if 'v=' in link else link.split('/')[-1].split('?')[0] %}
                <div class="viewer-container p-4">
                    <div class="video-container">
                        <iframe src="https://www.youtube.com/embed/{{ video_id }}" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
                    </div>
                </div>
            
            {# Vimeo #}
            {% elif 'vimeo.com' in link %}
                {% set video_id = link.split('/')[-1] %}
                <div class="viewer-container p-4">
                    <div class="video-container">
                        <iframe src="https://player.vimeo.com/video/{{ video_id }}" allowfullscreen></iframe>
                    </div>
                </div>
            
            {# Canva #}
            {% elif 'canva.com' in link %}
                <div class="viewer-container">
                    <iframe src="{{ link.replace('/design/', '/design/embed/') if '/embed/' not in link else link }}" class="viewer-frame" allowfullscreen></iframe>
                </div>
            
            {# Google Docs #}
            {% elif 'docs.google.com' in link %}
                {% set embed_link = link.replace('/edit', '/embed').replace('/view', '/embed') if '/embed' not in link else link %}
                <div class="viewer-container">
                    <iframe src="{{ embed_link }}" class="viewer-frame" allowfullscreen></iframe>
                </div>
            
            {# Loom #}
            {% elif 'loom.com' in link %}
                {% set video_id = link.split('/')[-1].split('?')[0] %}
                <div class="viewer-container p-4">
                    <div class="video-container">
                        <iframe src="https://www.loom.com/embed/{{ video_id }}" allowfullscreen></iframe>
                    </div>
                </div>
            
            {# Genel #}
            {% else %}
                <div class="viewer-container">
                    <iframe src="{{ link }}" class="viewer-frame" sandbox="allow-scripts allow-same-origin allow-popups" allowfullscreen></iframe>
                </div>
            {% endif %}
        
        {# Desteklenmeyen #}
        {% else %}
        <div class="py-16 text-center bg-gray-50 dark:bg-[#111418]">
            <span class="material-symbols-outlined text-6xl text-gray-400 mb-4">file_present</span>
            <h5 class="text-lg font-bold text-[#111418] dark:text-white mb-2">Görüntülenemiyor</h5>
            <p class="text-text-muted dark:text-text-muted-dark mb-6">Bu dosya formatı doğrudan görüntülenemiyor.</p>
            {% if materyal.dosya_yolu %}
            <a href="{{ url_for('egitim.materyal_indir', id=materyal.id) }}" class="inline-flex items-center gap-2 px-6 py-3 bg-primary hover:bg-primary-dark text-white font-bold rounded-lg transition-colors">
                <span class="material-symbols-outlined">download</span>Dosyayı İndir
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Materyal Bilgileri -->
<div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm mt-6">
    <div class="px-5 py-4 border-b border-border-light dark:border-border-dark">
        <h6 class="font-bold text-[#111418] dark:text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">info</span>
            Materyal Bilgileri
        </h6>
    </div>
    <div class="p-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-2 text-sm">
                <div class="flex justify-between py-2 border-b border-border-light dark:border-border-dark">
                    <span class="text-text-muted dark:text-text-muted-dark">Tip:</span>
                    {% set tip_colors = {
                        'dokuman': 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300',
                        'sunum': 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400',
                        'video': 'bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400',
                        'gorsel': 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-400',
                        'link': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400'
                    } %}
                    <span class="px-2 py-0.5 text-xs font-bold rounded-full {{ tip_colors.get(materyal.materyal_tipi, 'bg-gray-100 text-gray-700') }}">{{ materyal.materyal_tipi|title }}</span>
                </div>
                {% if materyal.dosya_adi %}
                <div class="flex justify-between py-2 border-b border-border-light dark:border-border-dark">
                    <span class="text-text-muted dark:text-text-muted-dark">Dosya:</span>
                    <span class="text-[#111418] dark:text-white">{{ materyal.dosya_adi }}</span>
                </div>
                {% endif %}
                {% if materyal.dosya_boyut %}
                <div class="flex justify-between py-2">
                    <span class="text-text-muted dark:text-text-muted-dark">Boyut:</span>
                    <span class="text-[#111418] dark:text-white">
                        {% if materyal.dosya_boyut > 1048576 %}{{ (materyal.dosya_boyut / 1048576)|round(2) }} MB{% else %}{{ (materyal.dosya_boyut / 1024)|round(1) }} KB{% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between py-2 border-b border-border-light dark:border-border-dark">
                    <span class="text-text-muted dark:text-text-muted-dark">Eğitim:</span>
                    <a href="{{ url_for('egitim.detay', id=materyal.egitim_id) }}" class="text-primary hover:underline">{{ materyal.egitim.baslik }}</a>
                </div>
                <div class="flex justify-between py-2 border-b border-border-light dark:border-border-dark">
                    <span class="text-text-muted dark:text-text-muted-dark">Yükleyen:</span>
                    <span class="text-[#111418] dark:text-white">{{ materyal.yukleyen.username if materyal.yukleyen else '-' }}</span>
                </div>
                <div class="flex justify-between py-2">
                    <span class="text-text-muted dark:text-text-muted-dark">Tarih:</span>
                    <span class="text-[#111418] dark:text-white">{{ materyal.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}