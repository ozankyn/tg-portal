{% extends "base.html" %}

{% block title %}{{ test.baslik }} - Sınav{% endblock %}
{% block page_title %}{{ test.baslik }}{% endblock %}

{% block extra_css %}
<style>
    .timer-box.warning { animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .secenek-input { display: none; }
    .secenek-label {
        display: block;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .secenek-label:hover { border-color: var(--color-primary); background-color: rgba(59, 130, 246, 0.05); }
    .secenek-input:checked + .secenek-label { border-color: var(--color-primary); background-color: rgba(59, 130, 246, 0.1); }
    .dark .secenek-label { border-color: #374151; }
    .dark .secenek-label:hover { background-color: rgba(59, 130, 246, 0.1); }
</style>
{% endblock %}

{% block content %}
<form method="POST" id="testForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Sol: Sorular -->
        <div class="lg:col-span-3 space-y-6">
            {% for ts in test_sorulari %}
            {% set soru = ts.soru %}
            {% set mevcut = mevcut_cevaplar.get(soru.id) %}
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm" id="soru-{{ loop.index }}">
                <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex justify-between items-center">
                    <span class="flex items-center gap-2">
                        <strong class="text-[#111418] dark:text-white">Soru {{ loop.index }}</strong>
                        {% set zorluk_renk = {'1': 'emerald', '2': 'amber', '3': 'rose'} %}
                        <span class="px-2 py-0.5 text-xs font-bold rounded-full bg-{{ zorluk_renk.get(soru.zorluk|string, 'gray') }}-100 text-{{ zorluk_renk.get(soru.zorluk|string, 'gray') }}-700">{{ soru.zorluk_text }}</span>
                    </span>
                    <span class="px-2 py-1 text-xs font-bold bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-full">{{ ts.puan }} puan</span>
                </div>
                <div class="p-5">
                    <p class="text-lg text-[#111418] dark:text-white mb-6">{{ soru.soru_metni }}</p>
                    
                    {% if soru.gorsel_url %}
                    <img src="{{ soru.gorsel_url }}" class="max-w-full mb-6 rounded-lg" alt="Soru görseli">
                    {% endif %}
                    
                    <div class="space-y-3">
                        {% set secenekler = soru.secenekler.all() %}
                        {% if test.secenek_karistir %}{% set secenekler = secenekler|shuffle %}{% endif %}
                        
                        {% for secenek in secenekler %}
                        <div>
                            {% if soru.soru_tipi == 'coklu_secim' %}
                            <input type="checkbox" name="soru_{{ soru.id }}" value="{{ secenek.id }}" 
                                   class="secenek-input" id="secenek_{{ secenek.id }}"
                                   data-soru="{{ loop.parent.loop.index }}"
                                   {{ 'checked' if mevcut and mevcut.secilen_secenekler and secenek.id in mevcut.secilen_secenekler }}>
                            {% else %}
                            <input type="radio" name="soru_{{ soru.id }}" value="{{ secenek.id }}" 
                                   class="secenek-input" id="secenek_{{ secenek.id }}"
                                   data-soru="{{ loop.parent.loop.index }}"
                                   {{ 'checked' if mevcut and mevcut.secilen_secenek_id == secenek.id }}>
                            {% endif %}
                            <label for="secenek_{{ secenek.id }}" class="secenek-label">
                                <span class="font-bold mr-2 text-primary">{{ ['A', 'B', 'C', 'D', 'E', 'F'][loop.index0] }})</span>
                                <span class="text-[#111418] dark:text-white">{{ secenek.secenek_metni }}</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Alt Butonlar -->
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm p-5 flex justify-between items-center">
                <button type="submit" name="kaydet" class="px-4 py-2 border border-primary text-primary hover:bg-primary/10 font-medium rounded-lg transition-colors flex items-center gap-2">
                    <span class="material-symbols-outlined">save</span>Kaydet (Devam Et)
                </button>
                <button type="button" onclick="confirmFinish()" class="px-6 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-lg transition-colors flex items-center gap-2">
                    <span class="material-symbols-outlined">check_circle</span>Sınavı Bitir
                </button>
            </div>
        </div>
        
        <!-- Sağ: Timer ve Navigasyon -->
        <div class="space-y-4">
            <!-- Timer -->
            {% if kalan_sure is not none %}
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm timer-box sticky top-4" id="timerBox">
                <div class="p-5 text-center">
                    <h6 class="text-text-muted dark:text-text-muted-dark text-sm mb-2">Kalan Süre</h6>
                    <div class="text-4xl font-bold text-[#111418] dark:text-white" id="timer">
                        <span id="dakika">{{ (kalan_sure // 60)|int }}</span>:<span id="saniye">{{ '%02d'|format(kalan_sure % 60) }}</span>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Soru Navigasyonu -->
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm sticky top-{{ '28' if kalan_sure is not none else '4' }}">
                <div class="px-5 py-4 border-b border-border-light dark:border-border-dark">
                    <h6 class="font-bold text-[#111418] dark:text-white">Sorular</h6>
                </div>
                <div class="p-5">
                    <div class="flex flex-wrap gap-2 mb-4">
                        {% for ts in test_sorulari %}
                        {% set mevcut = mevcut_cevaplar.get(ts.soru_id) %}
                        <a href="#soru-{{ loop.index }}" 
                           class="w-10 h-10 rounded-lg flex items-center justify-center font-bold text-sm transition-colors
                                  {{ 'bg-emerald-500 text-white' if mevcut and (mevcut.secilen_secenek_id or mevcut.secilen_secenekler) else 'border border-border-light dark:border-border-dark hover:bg-gray-50 dark:hover:bg-[#252b36]' }}"
                           id="nav-{{ loop.index }}">
                            {{ loop.index }}
                        </a>
                        {% endfor %}
                    </div>
                    
                    <div class="border-t border-border-light dark:border-border-dark pt-4 mb-4">
                        <div class="flex items-center gap-2 text-sm mb-1">
                            <span class="w-4 h-4 bg-emerald-500 rounded"></span>
                            <span class="text-text-muted dark:text-text-muted-dark">Cevaplandı</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm">
                            <span class="w-4 h-4 border border-border-light dark:border-border-dark rounded"></span>
                            <span class="text-text-muted dark:text-text-muted-dark">Boş</span>
                        </div>
                    </div>
                    
                    <div class="border-t border-border-light dark:border-border-dark pt-4 text-center text-sm text-text-muted dark:text-text-muted-dark">
                        <strong class="text-[#111418] dark:text-white">{{ test_sorulari|length }}</strong> soru<br>
                        <strong class="text-[#111418] dark:text-white">{{ test.toplam_puan }}</strong> toplam puan<br>
                        <strong class="text-[#111418] dark:text-white">%{{ test.gecme_puani }}</strong> geçme
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <input type="hidden" name="bitir" id="bitirInput" value="">
</form>

<!-- Bitir Onay Modal -->
<div id="finishModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-card-dark rounded-xl w-full max-w-md">
        <div class="px-6 py-4 border-b border-border-light dark:border-border-dark flex justify-between items-center">
            <h5 class="font-bold text-lg text-[#111418] dark:text-white">Sınavı Bitir</h5>
            <button type="button" onclick="closeModal()" class="p-1 hover:bg-gray-100 dark:hover:bg-[#252b36] rounded-lg">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="p-6">
            <p class="text-[#111418] dark:text-white mb-4">Sınavı bitirmek istediğinize emin misiniz?</p>
            <div id="bosUyari" class="hidden bg-amber-50 dark:bg-amber-900/10 border border-amber-200 dark:border-amber-900/30 rounded-lg p-3 text-amber-800 dark:text-amber-300 text-sm flex items-center gap-2">
                <span class="material-symbols-outlined">warning</span>
                <span><strong id="bosSayi">0</strong> soru boş bırakıldı!</span>
            </div>
        </div>
        <div class="px-6 py-4 border-t border-border-light dark:border-border-dark flex justify-end gap-3">
            <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-medium rounded-lg transition-colors">Devam Et</button>
            <button type="button" onclick="finishTest()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-lg transition-colors">Sınavı Bitir</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
{% if kalan_sure is not none %}
let kalanSure = {{ kalan_sure }};
const timerInterval = setInterval(function() {
    kalanSure--;
    if (kalanSure <= 0) {
        clearInterval(timerInterval);
        document.getElementById('bitirInput').value = '1';
        document.getElementById('testForm').submit();
        return;
    }
    const dakika = Math.floor(kalanSure / 60);
    const saniye = kalanSure % 60;
    document.getElementById('dakika').textContent = dakika;
    document.getElementById('saniye').textContent = saniye.toString().padStart(2, '0');
    if (kalanSure <= 300) {
        document.getElementById('timerBox').classList.add('warning');
        document.getElementById('timer').classList.add('text-rose-500');
    }
}, 1000);
{% endif %}

document.querySelectorAll('.secenek-input').forEach(input => {
    input.addEventListener('change', function() {
        const soruNo = this.dataset.soru;
        const navBtn = document.getElementById('nav-' + soruNo);
        const soruName = this.name;
        const anyChecked = document.querySelector('input[name="' + soruName + '"]:checked');
        if (anyChecked) {
            navBtn.classList.remove('border', 'border-border-light', 'dark:border-border-dark', 'hover:bg-gray-50', 'dark:hover:bg-[#252b36]');
            navBtn.classList.add('bg-emerald-500', 'text-white');
        } else {
            navBtn.classList.add('border', 'border-border-light', 'dark:border-border-dark', 'hover:bg-gray-50', 'dark:hover:bg-[#252b36]');
            navBtn.classList.remove('bg-emerald-500', 'text-white');
        }
    });
});

function confirmFinish() {
    let bosSayi = 0;
    {% for ts in test_sorulari %}
    if (!document.querySelector('input[name="soru_{{ ts.soru_id }}"]:checked')) bosSayi++;
    {% endfor %}
    if (bosSayi > 0) {
        document.getElementById('bosSayi').textContent = bosSayi;
        document.getElementById('bosUyari').classList.remove('hidden');
    } else {
        document.getElementById('bosUyari').classList.add('hidden');
    }
    document.getElementById('finishModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('finishModal').classList.add('hidden');
}

function finishTest() {
    document.getElementById('bitirInput').value = '1';
    document.getElementById('testForm').submit();
}

window.addEventListener('beforeunload', function(e) { e.preventDefault(); e.returnValue = ''; });
document.getElementById('testForm').addEventListener('submit', function() { window.removeEventListener('beforeunload', function() {}); });
</script>
{% endblock %}