{% extends "base.html" %}

{% block title %}Sınav Sonucu - {{ test.baslik }}{% endblock %}
{% block page_title %}Sınav Sonucu{% endblock %}

{% block content %}
<div class="flex justify-center mb-6">
    <div class="w-full max-w-2xl">
        <!-- Ana Sonuç Kartı -->
        <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm overflow-hidden">
            <div class="p-8 text-center">
                {% if sonuc.gecti %}
                <span class="material-symbols-outlined text-7xl text-emerald-500 mb-4">trophy</span>
                <h2 class="text-2xl font-bold text-emerald-600 mb-4">Tebrikler! Sınavı Geçtiniz</h2>
                {% else %}
                <span class="material-symbols-outlined text-7xl text-rose-500 mb-4">cancel</span>
                <h2 class="text-2xl font-bold text-rose-600 mb-4">Maalesef Geçemediniz</h2>
                {% endif %}
                
                <div class="text-6xl font-bold text-[#111418] dark:text-white mb-6">%{{ sonuc.yuzde }}</div>
                
                <div class="w-full h-6 bg-gray-200 dark:bg-gray-700 rounded-full mb-6 overflow-hidden">
                    <div class="h-full {{ 'bg-emerald-500' if sonuc.gecti else 'bg-rose-500' }} rounded-full transition-all" style="width: {{ sonuc.yuzde }}%"></div>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <div class="text-3xl font-bold text-emerald-500">{{ sonuc.dogru_sayisi }}</div>
                        <div class="text-text-muted dark:text-text-muted-dark text-sm">Doğru</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-rose-500">{{ sonuc.yanlis_sayisi }}</div>
                        <div class="text-text-muted dark:text-text-muted-dark text-sm">Yanlış</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-gray-500">{{ sonuc.bos_sayisi }}</div>
                        <div class="text-text-muted dark:text-text-muted-dark text-sm">Boş</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Detaylı İstatistikler -->
    <div>
        <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm mb-6">
            <div class="px-5 py-4 border-b border-border-light dark:border-border-dark">
                <h6 class="font-bold text-[#111418] dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">bar_chart</span>
                    İstatistikler
                </h6>
            </div>
            <div class="divide-y divide-border-light dark:divide-border-dark">
                <div class="px-5 py-3 flex justify-between items-center">
                    <span class="text-text-muted dark:text-text-muted-dark text-sm">Toplam Puan</span>
                    <strong class="text-[#111418] dark:text-white">{{ sonuc.alinan_puan }} / {{ sonuc.toplam_puan }}</strong>
                </div>
                <div class="px-5 py-3 flex justify-between items-center">
                    <span class="text-text-muted dark:text-text-muted-dark text-sm">Geçme Puanı</span>
                    <strong class="text-[#111418] dark:text-white">%{{ test.gecme_puani }}</strong>
                </div>
                <div class="px-5 py-3 flex justify-between items-center">
                    <span class="text-text-muted dark:text-text-muted-dark text-sm">Süre</span>
                    <strong class="text-[#111418] dark:text-white">{{ sonuc.sure_text }}</strong>
                </div>
                <div class="px-5 py-3 flex justify-between items-center">
                    <span class="text-text-muted dark:text-text-muted-dark text-sm">Başlangıç</span>
                    <span class="text-[#111418] dark:text-white text-sm">{{ sonuc.baslangic_zamani.strftime('%d.%m.%Y %H:%M') }}</span>
                </div>
                <div class="px-5 py-3 flex justify-between items-center">
                    <span class="text-text-muted dark:text-text-muted-dark text-sm">Bitiş</span>
                    <span class="text-[#111418] dark:text-white text-sm">{{ sonuc.bitis_zamani.strftime('%d.%m.%Y %H:%M') if sonuc.bitis_zamani else '-' }}</span>
                </div>
            </div>
        </div>
        
        <div class="space-y-3">
            {% if not sonuc.gecti and test.tekrar_hak %}
                {% set cozum_sayisi = test.sonuclar.filter_by(calisan_id=sonuc.calisan_id, tamamlandi=True).count() %}
                {% if cozum_sayisi < test.tekrar_hak %}
                <a href="{{ url_for('egitim.test_baslat', id=test.id) }}" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-primary hover:bg-primary-dark text-white font-bold rounded-lg transition-colors">
                    <span class="material-symbols-outlined">refresh</span>
                    Tekrar Dene ({{ test.tekrar_hak - cozum_sayisi }} hak)
                </a>
                {% endif %}
            {% endif %}
            
            {% if test.egitim_id %}
            <a href="{{ url_for('egitim.detay', id=test.egitim_id) }}" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 border border-border-light dark:border-border-dark hover:bg-gray-50 dark:hover:bg-[#252b36] font-medium rounded-lg transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
                Eğitime Dön
            </a>
            {% else %}
            <a href="{{ url_for('egitim.test_liste') }}" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 border border-border-light dark:border-border-dark hover:bg-gray-50 dark:hover:bg-[#252b36] font-medium rounded-lg transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
                Testlere Dön
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Soru Bazlı Sonuçlar -->
    <div class="lg:col-span-2">
        {% if test.sonucu_goster %}
        <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
            <div class="px-5 py-4 border-b border-border-light dark:border-border-dark">
                <h6 class="font-bold text-[#111418] dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">fact_check</span>
                    Soru Detayları
                </h6>
            </div>
            <div class="p-5 space-y-4">
                {% for item in cevaplar %}
                {% set soru = item.soru %}
                {% set cevap = item.cevap %}
                <div class="border-l-4 {{ 'border-emerald-500' if cevap and cevap.dogru else ('border-rose-500' if cevap and cevap.secilen_secenek_id else 'border-gray-400') }} bg-gray-50 dark:bg-[#111418] rounded-r-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <strong class="text-[#111418] dark:text-white">Soru {{ loop.index }}</strong>
                        {% if cevap and cevap.dogru %}
                        <span class="px-2 py-1 text-xs font-bold rounded-full bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">check</span>Doğru (+{{ cevap.alinan_puan }})
                        </span>
                        {% elif cevap and cevap.secilen_secenek_id %}
                        <span class="px-2 py-1 text-xs font-bold rounded-full bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400 flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">close</span>Yanlış
                        </span>
                        {% else %}
                        <span class="px-2 py-1 text-xs font-bold rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400">Boş</span>
                        {% endif %}
                    </div>
                    
                    <p class="text-[#111418] dark:text-white text-sm mb-3">{{ soru.soru_metni }}</p>
                    
                    {% if test.dogru_cevaplari_goster %}
                    <div class="text-sm space-y-1">
                        {% if cevap and cevap.secilen_secenek %}
                        <div class="{{ 'text-emerald-600' if cevap.dogru else 'text-rose-600' }}">
                            <strong>Cevabınız:</strong> {{ cevap.secilen_secenek.secenek_metni }}
                        </div>
                        {% endif %}
                        
                        {% if not cevap or not cevap.dogru %}
                        <div class="text-emerald-600">
                            <strong>Doğru Cevap:</strong> {{ soru.dogru_secenek.secenek_metni if soru.dogru_secenek else '-' }}
                        </div>
                        {% endif %}
                        
                        {% if soru.aciklama %}
                        <div class="text-text-muted dark:text-text-muted-dark mt-2 flex items-start gap-1">
                            <span class="material-symbols-outlined text-sm mt-0.5">info</span>
                            {{ soru.aciklama }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
            <div class="py-12 text-center">
                <span class="material-symbols-outlined text-5xl text-gray-300 dark:text-gray-600 mb-2">visibility_off</span>
                <p class="text-text-muted dark:text-text-muted-dark">Soru detayları bu test için gösterilmiyor.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}