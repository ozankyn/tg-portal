{% extends "base.html" %}

{% block title %}Onay Talebi #{{ talep.id }} - TG Portal{% endblock %}
{% block page_title %}Onay Talebi{% endblock %}

{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -24px;
        top: 4px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #6c757d;
        border: 2px solid #fff;
    }
    .timeline-item.success::before { background: #198754; }
    .timeline-item.danger::before { background: #dc3545; }
    .timeline-item.warning::before { background: #ffc107; }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Sol: Talep Bilgileri -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Talep Bilgileri</h6>
                <span class="badge bg-{{ talep.durum_renk }}">{{ talep.durum_text }}</span>
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                    <span class="text-muted">Talep No</span>
                    <strong>#{{ talep.id }}</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span class="text-muted">Tip</span>
                    <strong>{{ talep.onay_tipi.ad }}</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span class="text-muted">Talep Eden</span>
                    <strong>{{ talep.talep_eden.username }}</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span class="text-muted">Tarih</span>
                    <span>{{ talep.talep_tarihi.strftime('%d.%m.%Y %H:%M') }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span class="text-muted">Akış</span>
                    <span>{{ talep.akis.ad }}</span>
                </li>
                {% if talep.acil %}
                <li class="list-group-item">
                    <span class="badge bg-danger">ACİL</span>
                </li>
                {% endif %}
            </ul>
        </div>
        
        <!-- Referans Kayıt Özeti -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">İlgili Kayıt</h6>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-1">{{ referans.tablo }}</p>
                <p class="mb-0">#{{ referans.id }}</p>
                <!-- Buraya referans detayları eklenecek -->
            </div>
        </div>
        
        <!-- Talep Eden İşlemleri -->
        {% if is_talep_eden and talep.durum == 'bekliyor' %}
        <div class="card border-warning">
            <div class="card-body">
                <form method="POST" action="{{ url_for('onay.talep_iptal', id=talep.id) }}"
                      onsubmit="return confirm('Talebi iptal etmek istediğinize emin misiniz?')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-warning w-100">
                        <i class="bi bi-x-circle me-2"></i> Talebi İptal Et
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Sağ: Timeline ve Onay Formu -->
    <div class="col-lg-8">
        <!-- Onay/Red Formu (bekleyen onay varsa) -->
        {% if bekleyen_kayit %}
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-check2-square me-2"></i>Onay Bekliyor</h6>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    <strong>Adım:</strong> {{ bekleyen_kayit.adim.ad }}
                    {% if bekleyen_kayit.vekil_mi %}
                    <span class="badge bg-info ms-2">{{ bekleyen_kayit.asil_onaylayici.username }} adına vekil onay</span>
                    {% endif %}
                </p>
                
                <div class="mb-3">
                    <label class="form-label">Not (opsiyonel)</label>
                    <textarea id="onayNot" class="form-control" rows="2" placeholder="Onay/red notunuz..."></textarea>
                </div>
                
                <div class="d-flex gap-2">
                    <form method="POST" action="{{ url_for('onay.onayla', id=bekleyen_kayit.id) }}" class="flex-grow-1" id="onayForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="not" id="onayNotInput">
                        <button type="submit" class="btn btn-success w-100 btn-lg">
                            <i class="bi bi-check-lg me-2"></i> Onayla
                        </button>
                    </form>
                    
                    <form method="POST" action="{{ url_for('onay.reddet', id=bekleyen_kayit.id) }}" id="redForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="not" id="redNotInput">
                        <button type="submit" class="btn btn-outline-danger btn-lg">
                            <i class="bi bi-x-lg me-2"></i> Reddet
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Timeline -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Onay Geçmişi</h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <!-- Talep Oluşturuldu -->
                    <div class="timeline-item success">
                        <div class="d-flex justify-content-between">
                            <strong>Talep Oluşturuldu</strong>
                            <small class="text-muted">{{ talep.talep_tarihi.strftime('%d.%m.%Y %H:%M') }}</small>
                        </div>
                        <small class="text-muted">{{ talep.talep_eden.username }} tarafından</small>
                    </div>
                    
                    <!-- Onay Kayıtları -->
                    {% for kayit in talep.timeline %}
                    <div class="timeline-item {{ kayit.durum_renk }}">
                        <div class="d-flex justify-content-between">
                            <strong>{{ kayit.adim.ad }}</strong>
                            {% if kayit.islem_tarihi %}
                            <small class="text-muted">{{ kayit.islem_tarihi.strftime('%d.%m.%Y %H:%M') }}</small>
                            {% endif %}
                        </div>
                        <div>
                            <span class="badge bg-{{ kayit.durum_renk }}">{{ kayit.durum_text }}</span>
                            {% if kayit.onaylayici %}
                            <small class="text-muted ms-2">{{ kayit.onaylayici.username }}</small>
                            {% endif %}
                            {% if kayit.vekil_mi %}
                            <small class="text-info ms-1">({{ kayit.asil_onaylayici.username }} adına)</small>
                            {% endif %}
                        </div>
                        {% if kayit.not_ %}
                        <div class="mt-1 p-2 bg-light rounded small">
                            <i class="bi bi-chat-quote me-1"></i> {{ kayit.not_ }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    
                    <!-- Sonuç -->
                    {% if talep.durum != 'bekliyor' %}
                    <div class="timeline-item {{ 'success' if talep.durum == 'onaylandi' else 'danger' }}">
                        <div class="d-flex justify-content-between">
                            <strong>{{ talep.durum_text }}</strong>
                            {% if talep.sonuc_tarihi %}
                            <small class="text-muted">{{ talep.sonuc_tarihi.strftime('%d.%m.%Y %H:%M') }}</small>
                            {% endif %}
                        </div>
                        {% if talep.sonuc_notu %}
                        <div class="mt-1 p-2 bg-light rounded small">
                            {{ talep.sonuc_notu }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Not alanını formlara aktar
document.getElementById('onayForm')?.addEventListener('submit', function() {
    document.getElementById('onayNotInput').value = document.getElementById('onayNot').value;
});

document.getElementById('redForm')?.addEventListener('submit', function(e) {
    const not = document.getElementById('onayNot').value;
    if (!not.trim()) {
        e.preventDefault();
        alert('Red nedeni zorunludur.');
        return false;
    }
    document.getElementById('redNotInput').value = not;
});
</script>
{% endblock %}
