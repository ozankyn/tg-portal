{% extends "base.html" %}

{% block title %}{{ 'Masraf Düzenle' if masraf else 'Yeni Masraf' }} - TG Portal{% endblock %}
{% block page_title %}{{ 'Masraf Düzenle' if masraf else 'Yeni Masraf' }}{% endblock %}

{% block content %}
<form method="POST" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Sol: Ana Bilgiler -->
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark">
                <div class="px-5 py-4 border-b border-border-light dark:border-border-dark">
                    <h3 class="font-semibold text-[#111418] dark:text-white">Masraf Bilgileri</h3>
                </div>
                <div class="p-5">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Açıklama *</label>
                            <input type="text" name="baslik" required
                                   value="{{ masraf.baslik if masraf else '' }}"
                                   placeholder="Örn: Müşteri ziyareti taksi ücreti"
                                   class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Tarih *</label>
                            <input type="date" name="masraf_tarihi" required
                                   value="{{ masraf.masraf_tarihi.strftime('%Y-%m-%d') if masraf else '' }}"
                                   class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Kategori *</label>
                            <select name="kategori_id" id="kategoriSelect" required
                                    class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Seçin...</option>
                                {% for k in kategoriler %}
                                <option value="{{ k.id }}" 
                                        data-fatura-zorunlu="{{ 'true' if k.fatura_zorunlu else 'false' }}"
                                        {{ 'selected' if (masraf and masraf.kategori_id == k.id) or request.args.get('kategori_id')|int == k.id }}>
                                    {{ k.ad }}
                                </option>
                                {% endfor %}
                            </select>
                            <p id="faturaUyari" class="mt-1 text-sm text-yellow-600 hidden">
                                <span class="material-symbols-outlined text-sm align-middle">warning</span>
                                Bu kategori için fatura/fiş zorunludur
                            </p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Proje (Opsiyonel)</label>
                            <select name="proje_id" class="select2 w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Proje Yok</option>
                                {% for p in projeler %}
                                <option value="{{ p.id }}" {{ 'selected' if masraf and masraf.proje_id == p.id }}>
                                    {{ p.ad }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Detaylı Açıklama</label>
                            <textarea name="aciklama" rows="2"
                                      placeholder="İsteğe bağlı ek detaylar..."
                                      class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{{ masraf.aciklama if masraf else '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tutar Bilgileri -->
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark">
                <div class="px-5 py-4 border-b border-border-light dark:border-border-dark">
                    <h3 class="font-semibold text-[#111418] dark:text-white">Tutar Bilgileri</h3>
                </div>
                <div class="p-5">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Tutar (KDV Hariç) *</label>
                            <div class="flex">
                                <input type="text" name="tutar" required id="tutarInput"
                                       value="{{ masraf.tutar if masraf else '' }}" placeholder="0.00"
                                       class="flex-1 px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <select name="para_birimi" id="paraBirimiSelect"
                                        class="px-3 py-2 border border-l-0 border-border-light dark:border-border-dark dark:bg-[#111418] rounded-r-lg bg-gray-50 dark:bg-[#111418] focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="TRY" {{ 'selected' if not masraf or masraf.para_birimi == 'TRY' }}>₺</option>
                                    <option value="USD" {{ 'selected' if masraf and masraf.para_birimi == 'USD' }}>$</option>
                                    <option value="EUR" {{ 'selected' if masraf and masraf.para_birimi == 'EUR' }}>€</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">KDV Oranı</label>
                            <select name="kdv_orani" id="kdvOraniSelect"
                                    class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="20" {{ 'selected' if not masraf or masraf.kdv_orani == 20 }}>%20</option>
                                <option value="10" {{ 'selected' if masraf and masraf.kdv_orani == 10 }}>%10</option>
                                <option value="1" {{ 'selected' if masraf and masraf.kdv_orani == 1 }}>%1</option>
                                <option value="0" {{ 'selected' if masraf and masraf.kdv_orani == 0 }}>%0 (KDV Yok)</option>
                            </select>
                        </div>
                        
                        <div id="kurDiv" class="hidden">
                            <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Kur</label>
                            <input type="text" name="kur" id="kurInput"
                                   value="{{ masraf.kur if masraf else '' }}" placeholder="1.0000"
                                   class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Toplam</label>
                            <div id="toplamGosterge" class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-800 border border-border-light dark:border-border-dark rounded-lg text-[#111418] dark:text-white font-semibold">
                                ₺0.00
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Fatura/Fiş Bilgileri -->
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark">
                <div class="px-5 py-4 border-b border-border-light dark:border-border-dark">
                    <h3 class="font-semibold text-[#111418] dark:text-white">Fatura/Fiş Bilgileri</h3>
                </div>
                <div class="p-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Firma Adı</label>
                            <input type="text" name="firma_adi"
                                   value="{{ masraf.firma_adi if masraf else '' }}"
                                   placeholder="Faturayı kesen firma"
                                   class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Fatura/Fiş No</label>
                            <input type="text" name="fatura_no"
                                   value="{{ masraf.fatura_no if masraf else '' }}"
                                   placeholder="Fatura numarası"
                                   class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sağ: Dosya Yükleme -->
        <div class="space-y-6">
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark">
                <div class="px-5 py-4 border-b border-border-light dark:border-border-dark">
                    <h3 class="font-semibold text-[#111418] dark:text-white">Fatura/Fiş Görseli</h3>
                </div>
                <div class="p-5">
                    {% if masraf and masraf.dosya_yolu %}
                    <div class="mb-4 p-4 bg-gray-50 dark:bg-[#111418] rounded-lg text-center">
                        <span class="material-symbols-outlined text-4xl text-green-500">task</span>
                        <p class="text-sm text-text-muted dark:text-text-muted-dark mt-1">{{ masraf.dosya_adi }}</p>
                        <a href="{{ url_for('masraf.dosya_indir', id=masraf.id) }}" class="inline-flex items-center gap-1 mt-2 text-sm text-blue-600 hover:text-blue-700">
                            <span class="material-symbols-outlined text-sm">download</span>
                            İndir
                        </a>
                    </div>
                    <hr class="mb-4">
                    <p class="text-sm text-text-muted dark:text-text-muted-dark mb-2">Yeni dosya yüklerseniz mevcut dosya değiştirilecektir:</p>
                    {% endif %}
                    
                    <div class="mb-4">
                        <input type="file" name="dosya" id="dosyaInput"
                               accept=".pdf,.jpg,.jpeg,.png,.gif"
                               class="w-full text-sm text-text-muted dark:text-text-muted-dark file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <p class="text-xs text-text-muted dark:text-text-muted-dark mt-1">PDF, JPG, PNG (Max 10MB)</p>
                    </div>
                    
                    <!-- Önizleme -->
                    <div id="dosyaOnizleme" class="text-center hidden">
                        <img id="onizlemeImg" src="" class="max-h-72 rounded-lg mb-2 mx-auto">
                        <p id="onizlemeDosyaAdi" class="text-sm text-text-muted dark:text-text-muted-dark"></p>
                    </div>
                </div>
            </div>
            
            <!-- Kaydet Butonları -->
            <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark p-5 space-y-2">
                <button type="submit" class="flex items-center justify-center gap-2 w-full px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <span class="material-symbols-outlined text-lg">check</span>
                    {{ 'Güncelle' if masraf else 'Kaydet' }}
                </button>
                <a href="{{ url_for('masraf.dashboard') }}" class="flex items-center justify-center gap-2 w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 text-text-muted dark:text-text-muted-dark rounded-lg hover:bg-gray-50 dark:hover:bg-[#252b36] transition-colors">
                    İptal
                </a>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Kategori değişince fatura zorunluluğu kontrolü
    $('#kategoriSelect').change(function() {
        var selected = $(this).find('option:selected');
        var faturaZorunlu = selected.data('fatura-zorunlu') === true;
        if (faturaZorunlu) {
            $('#faturaUyari').removeClass('hidden');
        } else {
            $('#faturaUyari').addClass('hidden');
        }
    }).trigger('change');
    
    // Para birimi değişince kur alanını göster
    $('#paraBirimiSelect').change(function() {
        var isTRY = $(this).val() === 'TRY';
        if (isTRY) {
            $('#kurDiv').addClass('hidden');
        } else {
            $('#kurDiv').removeClass('hidden');
        }
        hesaplaToplam();
    }).trigger('change');
    
    // Tutar/KDV değişince toplam hesapla
    $('#tutarInput, #kdvOraniSelect, #kurInput').on('input change', hesaplaToplam);
    
    function hesaplaToplam() {
        var tutar = parseFloat($('#tutarInput').val().replace(',', '.')) || 0;
        var kdvOrani = parseInt($('#kdvOraniSelect').val()) || 0;
        var kur = parseFloat($('#kurInput').val().replace(',', '.')) || 1;
        var paraBirimi = $('#paraBirimiSelect').val();
        
        var kdv = tutar * kdvOrani / 100;
        var toplam = tutar + kdv;
        var tlKarsiligi = paraBirimi !== 'TRY' ? toplam * kur : toplam;
        
        var sembol = paraBirimi === 'USD' ? '$' : paraBirimi === 'EUR' ? '€' : '₺';
        var gosterge = sembol + toplam.toFixed(2);
        
        if (paraBirimi !== 'TRY') {
            gosterge += ' (₺' + tlKarsiligi.toFixed(2) + ')';
        }
        
        $('#toplamGosterge').text(gosterge);
    }
    
    hesaplaToplam();
    
    // Dosya önizleme
    $('#dosyaInput').change(function() {
        var file = this.files[0];
        if (file) {
            $('#onizlemeDosyaAdi').text(file.name);
            
            if (file.type.startsWith('image/')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#onizlemeImg').attr('src', e.target.result);
                    $('#dosyaOnizleme').removeClass('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                $('#onizlemeImg').attr('src', '');
                $('#dosyaOnizleme').removeClass('hidden');
            }
        } else {
            $('#dosyaOnizleme').addClass('hidden');
        }
    });
});
</script>
{% endblock %}
