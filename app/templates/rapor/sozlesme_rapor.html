{% extends "base.html" %}

{% block title %}Sözleşme Raporları - TG Portal{% endblock %}
{% block page_title %}Sözleşme Raporları{% endblock %}

{% block content %}
<div class="space-y-6">

  <!-- İstatistikler -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm p-5">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-xs font-semibold text-text-muted dark:text-text-muted-dark">Toplam Sözleşme</div>
          <div class="mt-1 text-3xl font-extrabold text-[#111418] dark:text-white">{{ stats.toplam }}</div>
        </div>
        <div class="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center">
          <span class="material-symbols-outlined text-blue-600 dark:text-blue-300">description</span>
        </div>
      </div>
    </div>

    <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm p-5">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-xs font-semibold text-text-muted dark:text-text-muted-dark">Aktif</div>
          <div class="mt-1 text-3xl font-extrabold text-[#111418] dark:text-white">{{ stats.aktif }}</div>
        </div>
        <div class="w-12 h-12 rounded-2xl bg-green-500/10 flex items-center justify-center">
          <span class="material-symbols-outlined text-green-600 dark:text-green-300">check_circle</span>
        </div>
      </div>
    </div>

    <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm p-5">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-xs font-semibold text-text-muted dark:text-text-muted-dark">Sona Eren</div>
          <div class="mt-1 text-3xl font-extrabold text-[#111418] dark:text-white">{{ stats.sona_eren }}</div>
        </div>
        <div class="w-12 h-12 rounded-2xl bg-slate-500/10 flex items-center justify-center">
          <span class="material-symbols-outlined text-slate-700 dark:text-slate-200">event_busy</span>
        </div>
      </div>
    </div>

    <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm p-5">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-xs font-semibold text-text-muted dark:text-text-muted-dark">Toplam Değer</div>
          <div class="mt-1 text-3xl font-extrabold text-[#111418] dark:text-white">₺{{ "%.0f"|format(stats.toplam_deger) }}</div>
        </div>
        <div class="w-12 h-12 rounded-2xl bg-sky-500/10 flex items-center justify-center">
          <span class="material-symbols-outlined text-sky-600 dark:text-sky-300">payments</span>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Tip Dağılımı -->
    <div class="lg:col-span-6">
      <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm overflow-hidden">
        <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex items-center gap-2">
          <span class="material-symbols-outlined text-[20px] text-primary">pie_chart</span>
          <h3 class="font-bold text-[#111418] dark:text-white">Tip Dağılımı</h3>
        </div>
        <div class="p-5">
          <canvas id="tipChart" height="250"></canvas>
        </div>
      </div>
    </div>

    <!-- Tip Tablosu -->
    <div class="lg:col-span-6">
      <div class="rounded-2xl border border-border-light dark:border-border-dark bg-white dark:bg-card-dark shadow-sm overflow-hidden">
        <div class="px-5 py-4 border-b border-border-light dark:border-border-dark flex items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-[20px] text-primary">table_chart</span>
            <h3 class="font-bold text-[#111418] dark:text-white">Tip Detay</h3>
          </div>

          <a href="{{ url_for('rapor.export_excel', modul='sozlesme') }}"
             class="inline-flex items-center justify-center rounded-xl border border-green-300 dark:border-green-700
                    px-3 py-2 text-sm font-semibold text-green-700 dark:text-green-300
                    hover:bg-green-50 dark:hover:bg-green-900/20 transition"
             title="Excel İndir">
            <span class="material-symbols-outlined text-[18px]">download</span>
          </a>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 dark:bg-[#111418] text-xs font-bold uppercase tracking-wider text-text-muted dark:text-text-muted-dark">
              <tr>
                <th class="px-5 py-3 text-left">Tip</th>
                <th class="px-5 py-3 text-right">Adet</th>
                <th class="px-5 py-3 text-right">Toplam Değer</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border-light dark:divide-border-dark">
              {% for ad, adet, toplam in tip_dagilim %}
              <tr class="hover:bg-gray-50 dark:hover:bg-[#252b36]">
                <td class="px-5 py-3 font-semibold text-[#111418] dark:text-white">{{ ad }}</td>
                <td class="px-5 py-3 text-right text-text-muted dark:text-text-muted-dark">{{ adet }}</td>
                <td class="px-5 py-3 text-right text-text-muted dark:text-text-muted-dark">₺{{ "%.0f"|format(toplam or 0) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- Yaklaşan Bitiş -->
    <div class="lg:col-span-12">
      <div class="rounded-2xl border border-amber-200 dark:border-amber-800 bg-white dark:bg-card-dark shadow-sm overflow-hidden">
        <div class="px-5 py-4 border-b border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/15 flex items-center gap-2">
          <span class="material-symbols-outlined text-[20px] text-amber-700 dark:text-amber-300">warning</span>
          <h3 class="font-bold text-[#111418] dark:text-white">Yaklaşan Bitiş (30 Gün İçinde)</h3>
        </div>

        <div class="p-0">
          {% if yaklasan %}
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50 dark:bg-[#111418] text-xs font-bold uppercase tracking-wider text-text-muted dark:text-text-muted-dark">
                <tr>
                  <th class="px-5 py-3 text-left">Başlık</th>
                  <th class="px-5 py-3 text-left">Tip</th>
                  <th class="px-5 py-3 text-left">Taraf</th>
                  <th class="px-5 py-3 text-left">Bitiş Tarihi</th>
                  <th class="px-5 py-3 text-left">Kalan Gün</th>
                  <th class="px-5 py-3 text-left">Tutar</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border-light dark:divide-border-dark">
                {% for s in yaklasan %}
                <tr class="
                    {% if s.kalan_gun <= 7 %}bg-red-50 dark:bg-red-900/15{% elif s.kalan_gun <= 15 %}bg-amber-50 dark:bg-amber-900/15{% endif %}
                    hover:bg-gray-50 dark:hover:bg-[#252b36]
                ">
                  <td class="px-5 py-3">
                    <a href="{{ url_for('sozlesme.detay', id=s.id) }}"
                       class="font-semibold text-blue-700 dark:text-blue-300 hover:underline">
                      {{ s.baslik|truncate(30) }}
                    </a>
                  </td>
                  <td class="px-5 py-3 text-text-muted dark:text-text-muted-dark">{{ s.tip.ad if s.tip else '-' }}</td>
                  <td class="px-5 py-3 text-text-muted dark:text-text-muted-dark">{{ s.taraf_adi|truncate(20) }}</td>
                  <td class="px-5 py-3 text-text-muted dark:text-text-muted-dark">{{ s.bitis_tarihi.strftime('%d.%m.%Y') }}</td>
                  <td class="px-5 py-3">
                    <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-bold
                                 bg-gray-100 dark:bg-[#111418] border border-border-light dark:border-border-dark">
                      <span class="w-2 h-2 rounded-full mr-2
                        {% if s.kalan_gun_renk == 'danger' %}bg-red-500
                        {% elif s.kalan_gun_renk == 'warning' %}bg-amber-500
                        {% elif s.kalan_gun_renk == 'success' %}bg-green-500
                        {% else %}bg-slate-400{% endif %}
                      "></span>
                      {{ s.kalan_gun }} gün
                    </span>
                  </td>
                  <td class="px-5 py-3 text-text-muted dark:text-text-muted-dark">₺{{ "%.0f"|format(s.tutar or 0) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="py-10 text-center text-text-muted dark:text-text-muted-dark">
            Yaklaşan sözleşme yok
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Geri -->
  <div>
    <a href="{{ url_for('rapor.dashboard') }}"
       class="inline-flex items-center gap-2 rounded-xl border border-border-light dark:border-border-dark px-4 py-2.5 font-semibold
              hover:bg-gray-50 dark:hover:bg-[#252b36] transition">
      <span class="material-symbols-outlined text-[18px]">arrow_back</span>
      Geri
    </a>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(document.getElementById('tipChart'), {
    type: 'doughnut',
    data: {
        labels: [{% for ad, adet, toplam in tip_dagilim %}'{{ ad }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for ad, adet, toplam in tip_dagilim %}{{ adet }}{% if not loop.last %},{% endif %}{% endfor %}],
            backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0', '#6f42c1']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'right' }
        }
    }
});
</script>
{% endblock %}
