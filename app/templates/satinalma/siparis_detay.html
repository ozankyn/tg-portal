{% extends "base.html" %}

{% block title %}{{ siparis.siparis_no }} - TG Portal{% endblock %}
{% block page_title %}Sipariş Detayı{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Sol: Sipariş Bilgileri -->
    <div class="lg:col-span-2 space-y-4">
        <!-- Başlık -->
        <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
            <div class="px-4 py-3 border-b border-border-light dark:border-border-dark flex justify-between items-center">
                <code class="text-lg font-semibold">{{ siparis.siparis_no }}</code>
                <span class="px-3 py-1 text-sm font-medium rounded-full bg-{{ siparis.durum_renk }}-100 text-{{ siparis.durum_renk }}-800">{{ siparis.durum_text }}</span>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-text-muted dark:text-text-muted-dark">Tedarikçi</label>
                        <p class="font-semibold">{{ siparis.tedarikci.unvan }}</p>
                    </div>
                    <div>
                        <label class="text-xs text-text-muted dark:text-text-muted-dark">Toplam Tutar</label>
                        <p class="text-2xl font-bold text-blue-600">₺{{ "%.2f"|format(siparis.toplam_tutar) }}</p>
                    </div>
                    <div>
                        <label class="text-xs text-text-muted dark:text-text-muted-dark">Sipariş Tarihi</label>
                        <p>{{ siparis.siparis_tarihi.strftime('%d.%m.%Y') }}</p>
                    </div>
                    <div>
                        <label class="text-xs text-text-muted dark:text-text-muted-dark">Beklenen Teslimat</label>
                        <p>{{ siparis.beklenen_teslimat.strftime('%d.%m.%Y') if siparis.beklenen_teslimat else '-' }}</p>
                    </div>
                    <div>
                        <label class="text-xs text-text-muted dark:text-text-muted-dark">Talep</label>
                        <p>
                            <a href="{{ url_for('satinalma.talep_detay', id=siparis.talep_id) }}" class="text-blue-600 hover:underline">
                                {{ siparis.talep.talep_no }}
                            </a>
                        </p>
                    </div>
                    {% if siparis.notlar %}
                    <div class="md:col-span-2">
                        <label class="text-xs text-text-muted dark:text-text-muted-dark">Notlar</label>
                        <p>{{ siparis.notlar }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Teslimatlar -->
        <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
            <div class="px-4 py-3 border-b border-border-light dark:border-border-dark flex justify-between items-center">
                <h6 class="font-medium text-[#111418] dark:text-white">Teslimat Kayıtları</h6>
                {% if current_user.has_permission('satinalma.admin') and siparis.durum in ['siparis_verildi', 'kismen_teslim'] %}
                <button class="inline-flex items-center gap-2 px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors" data-bs-toggle="modal" data-bs-target="#teslimatModal">
                    <span class="material-symbols-outlined">add</span>Teslimat Kaydet
                </button>
                {% endif %}
            </div>
            {% if teslimatlar %}
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 dark:bg-[#111418]">
                        <tr>
                            <th class="px-4 py-3 text-left font-medium text-text-muted dark:text-text-muted-dark">Tarih</th>
                            <th class="px-4 py-3 text-left font-medium text-text-muted dark:text-text-muted-dark">Teslim Alan</th>
                            <th class="px-4 py-3 text-left font-medium text-text-muted dark:text-text-muted-dark">İrsaliye No</th>
                            <th class="px-4 py-3 text-left font-medium text-text-muted dark:text-text-muted-dark">Notlar</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-border-light dark:divide-border-dark">
                        {% for t in teslimatlar %}
                        <tr>
                            <td class="px-4 py-3">{{ t.teslimat_tarihi.strftime('%d.%m.%Y') }}</td>
                            <td class="px-4 py-3">{{ t.teslim_alan.full_name if t.teslim_alan else '-' }}</td>
                            <td class="px-4 py-3">{{ t.irsaliye_no or '-' }}</td>
                            <td class="px-4 py-3">{{ t.notlar or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-text-muted dark:text-text-muted-dark text-center py-6">Henüz teslimat kaydı yok</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Sağ: İşlemler -->
    <div class="space-y-4">
        <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
            <div class="px-4 py-3 border-b border-border-light dark:border-border-dark">
                <h6 class="font-medium text-[#111418] dark:text-white">İşlemler</h6>
            </div>
            <div class="p-4">
                <a href="{{ url_for('satinalma.siparis_liste') }}" class="flex items-center justify-center gap-2 w-full px-4 py-2 border border-border-light dark:border-border-dark text-text-muted dark:text-text-muted-dark font-medium rounded-lg hover:bg-gray-50 dark:hover:bg-[#252b36] transition-colors">
                    <span class="material-symbols-outlined">arrow_back</span>Listeye Dön
                </a>
            </div>
        </div>
        
        <!-- Teklif Bilgisi -->
        {% if siparis.teklif %}
        <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
            <div class="px-4 py-3 border-b border-border-light dark:border-border-dark">
                <h6 class="font-medium text-[#111418] dark:text-white">Seçilen Teklif</h6>
            </div>
            <div class="p-4 text-sm space-y-2">
                <p><strong class="text-[#111418] dark:text-white">Teklif No:</strong> {{ siparis.teklif.teklif_no or '-' }}</p>
                <p><strong class="text-[#111418] dark:text-white">Tutar:</strong> ₺{{ "%.2f"|format(siparis.teklif.toplam_tutar) }}</p>
                <p><strong class="text-[#111418] dark:text-white">Teslimat:</strong> {{ siparis.teklif.teslimat_suresi or '-' }}</p>
                <p><strong class="text-[#111418] dark:text-white">Ödeme:</strong> {{ siparis.teklif.odeme_kosulu or '-' }}</p>
            </div>
        </div>
        {% endif %}
        
        <!-- Meta -->
        <div class="bg-white dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm p-4 text-sm text-text-muted dark:text-text-muted-dark">
            <div class="flex justify-between mb-1">
                <span>Oluşturulma:</span>
                <span>{{ siparis.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Teslimat Modal -->
<div class="modal fade" id="teslimatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('satinalma.teslimat_kaydet', id=siparis.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-header">
                    <h5 class="modal-title">Teslimat Kaydet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Teslimat Tarihi *</label>
                        <input type="date" name="teslimat_tarihi" class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">İrsaliye No</label>
                        <input type="text" name="irsaliye_no" class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Notlar</label>
                        <textarea name="notlar" class="w-full px-3 py-2 border border-border-light dark:border-border-dark dark:bg-[#111418] rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2"></textarea>
                    </div>
                    <div class="flex items-start">
                        <input type="checkbox" name="tam_teslimat" class="w-4 h-4 text-blue-600 border-border-light dark:border-border-dark rounded focus:ring-blue-500 mt-0.5" id="tamTeslimat">
                        <div class="ml-2">
                            <label class="font-medium text-[#111418] dark:text-white" for="tamTeslimat">Tam teslimat yapıldı</label>
                            <p class="text-xs text-text-muted dark:text-text-muted-dark">Sipariş tamamlandı olarak işaretlensin</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="px-4 py-2 border border-border-light dark:border-border-dark text-text-muted dark:text-text-muted-dark font-medium rounded-lg hover:bg-gray-50 dark:hover:bg-[#252b36]" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
