{% extends "base.html" %}

{% block title %}{{ arac.plaka }} - Araç Detay{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Başlık -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>
                <i class="fas fa-car"></i> {{ arac.plaka }}
                {% if arac.mulkiyet_tipi == 'Kiralık' %}
                <span class="badge bg-warning">Kiralık</span>
                {% else %}
                <span class="badge bg-success">Özmal</span>
                {% endif %}
            </h2>
            <p class="text-muted">{{ arac.marka }} {{ arac.model }} - {{ arac.yil or '-' }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('filo_araclar') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Araçlar
            </a>
            <a href="{{ url_for('filo_arac_duzenle', arac_id=arac.id) }}" class="btn btn-warning">
                <i class="fas fa-edit"></i> Düzenle
            </a>
        </div>
    </div>

    <!-- Özet Kartlar -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Durum</h6>
                    {% if arac.durum == 'Aktif' %}
                        <h4 class="text-success">{{ arac.durum }}</h4>
                    {% elif arac.durum == 'Bakımda' %}
                        <h4 class="text-warning">{{ arac.durum }}</h4>
                    {% else %}
                        <h4 class="text-danger">{{ arac.durum }}</h4>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Kilometre</h6>
                    <h4>{{ "{:,}".format(arac.guncel_km) }} km</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Zimmet</h6>
                    {% if zimmet %}
                        <h5 class="text-primary">
                            <i class="fas fa-user"></i> {{ zimmet.ad_soyad }}
                        </h5>
                        <small>{{ zimmet.teslim_tarihi }}</small>
                    {% else %}
                        <h5 class="text-secondary">Boşta</h5>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Sigorta Bitiş</h6>
                    {% if arac.sigorta_bitis_tarihi %}
                        <h5>{{ arac.sigorta_bitis_tarihi }}</h5>
                    {% else %}
                        <h5 class="text-muted">-</h5>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Menü -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#genel">
                <i class="fas fa-info-circle"></i> Genel Bilgiler
            </button>
        </li>
        {% if arac.mulkiyet_tipi == 'Kiralık' %}
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#kiralama">
                <i class="fas fa-file-contract"></i> Kiralama
            </button>
        </li>
        {% endif %}
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#gecmis">
                <i class="fas fa-history"></i> Teslim/İade Geçmişi
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#bakim">
                <i class="fas fa-wrench"></i> Bakım ({{ bakim_kayitlari|length }})
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#yakit">
                <i class="fas fa-gas-pump"></i> Yakıt ({{ yakit_kayitlari|length }})
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sigorta">
                <i class="fas fa-shield-alt"></i> Sigorta/Kaza
            </button>
        </li>
    </ul>

    <!-- Tab İçerikleri -->
    <div class="tab-content">
        <!-- Genel Bilgiler -->
        <div class="tab-pane fade show active" id="genel">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Araç Bilgileri</h5>
                            <table class="table">
                                <tr><th>Plaka:</th><td>{{ arac.plaka }}</td></tr>
                                <tr><th>Marka/Model:</th><td>{{ arac.marka }} {{ arac.model }}</td></tr>
                                <tr><th>Yıl:</th><td>{{ arac.yil or '-' }}</td></tr>
                                <tr><th>Renk:</th><td>{{ arac.renk or '-' }}</td></tr>
                                <tr><th>Şasi No:</th><td>{{ arac.sasi_no or '-' }}</td></tr>
                                <tr><th>Motor No:</th><td>{{ arac.motor_no or '-' }}</td></tr>
                                <tr><th>Yakıt Tipi:</th><td>{{ arac.yakit_tipi or '-' }}</td></tr>
                                <tr><th>Mülkiyet:</th><td><strong>{{ arac.mulkiyet_tipi }}</strong></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Kilometre ve Tarihler</h5>
                            <table class="table">
                                <tr><th>Başlangıç KM:</th><td>{{ "{:,}".format(arac.baslangic_km) }}</td></tr>
                                <tr><th>Güncel KM:</th><td>{{ "{:,}".format(arac.guncel_km) }}</td></tr>
                                <tr><th>Muayene:</th><td>{{ arac.muayene_tarihi or '-' }}</td></tr>
                                <tr><th>Sonraki Muayene:</th><td>{{ arac.sonraki_muayene_tarihi or '-' }}</td></tr>
                                <tr><th>Sigorta Şirketi:</th><td>{{ arac.sigorta_sirket or '-' }}</td></tr>
                                <tr><th>Poliçe No:</th><td>{{ arac.sigorta_police_no or '-' }}</td></tr>
                                <tr><th>Sigorta Bitiş:</th><td>{{ arac.sigorta_bitis_tarihi or '-' }}</td></tr>
                            </table>
                        </div>
                    </div>
                    {% if arac.notlar %}
                    <div class="mt-3">
                        <h5>Notlar</h5>
                        <p>{{ arac.notlar }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Kiralama Bilgileri (sadece kiralık araçlar için) -->
        {% if arac.mulkiyet_tipi == 'Kiralık' %}
        <div class="tab-pane fade" id="kiralama">
            {% if kiralama %}
            <div class="card mb-3">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">Aktif Kiralama Bilgileri</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Şirket Bilgileri</h6>
                            <table class="table">
                                <tr><th>Kiralama Şirketi:</th><td>{{ kiralama.kiralama_sirket }}</td></tr>
                                <tr><th>Yetkili:</th><td>{{ kiralama.yetkili_kisi or '-' }}</td></tr>
                                <tr><th>Telefon:</th><td>{{ kiralama.sirket_telefon or '-' }}</td></tr>
                                <tr><th>Email:</th><td>{{ kiralama.sirket_email or '-' }}</td></tr>
                                <tr><th>Sözleşme No:</th><td>{{ kiralama.sozlesme_no or '-' }}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Sözleşme Detayları</h6>
                            <table class="table">
                                <tr><th>Başlangıç:</th><td>{{ kiralama.sozlesme_baslangic }}</td></tr>
                                <tr><th>Bitiş:</th><td>{{ kiralama.sozlesme_bitis }}</td></tr>
                                {% if session.get('role') in ['admin', 'finans'] and kiralama.aylik_kira_bedeli %}
                                <tr><th>Aylık Bedel:</th><td><strong>{{ "{:,.2f}".format(kiralama.aylik_kira_bedeli) }} {{ kiralama.para_birimi }}</strong></td></tr>
                                {% endif %}
                                <tr><th>KM Limiti:</th><td>{{ kiralama.km_limiti or '-' }}</td></tr>
                                <tr><th>Sigorta:</th><td>{{ 'Dahil' if kiralama.sigorta_dahil else 'Dahil Değil' }}</td></tr>
                                <tr><th>Bakım:</th><td>{{ 'Dahil' if kiralama.bakim_dahil else 'Dahil Değil' }}</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('filo_kiralama_duzenle', kiralama_id=kiralama.id) }}" class="btn btn-warning">
                            <i class="fas fa-edit"></i> Düzenle
                        </a>
                        {% if session.get('role') in ['admin', 'finans'] %}
                        <a href="{{ url_for('filo_kiralama_odeme_ekle', kiralama_id=kiralama.id) }}" class="btn btn-success">
                            <i class="fas fa-money-bill"></i> Ödeme Ekle
                        </a>
                        {% endif %}
                        {% if kiralama.sozlesme_dosya_yolu %}
                        <a href="{{ url_for('static', filename='uploads/' + kiralama.sozlesme_dosya_yolu) }}" 
                           class="btn btn-info" target="_blank">
                            <i class="fas fa-file-pdf"></i> Sözleşme Görüntüle
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Bu araç için henüz kiralama bilgisi eklenmemiş.
                <a href="{{ url_for('filo_kiralama_ekle', arac_id=arac.id) }}" class="alert-link">
                    Kiralama bilgisi ekleyin
                </a>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Teslim/İade Geçmişi -->
        <div class="tab-pane fade" id="gecmis">
            {% if teslim_iade_gecmis %}
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>İşlem</th>
                                    <th>Çalışan</th>
                                    <th>KM</th>
                                    <th>Yakıt</th>
                                    <th>Hasar</th>
                                    <th>Teslim Eden</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for islem in teslim_iade_gecmis %}
                                <tr>
                                    <td>{{ islem.islem_tarihi }}</td>
                                    <td>
                                        {% if islem.islem_tipi == 'Teslim' %}
                                            <span class="badge bg-success">{{ islem.islem_tipi }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ islem.islem_tipi }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ islem.ad_soyad }}</td>
                                    <td>{{ "{:,}".format(islem.kilometre) }}</td>
                                    <td>{{ islem.yakit_durumu or '-' }}</td>
                                    <td>
                                        {% if islem.hasar_var %}
                                            <span class="badge bg-danger">Var</span>
                                        {% else %}
                                            <span class="badge bg-success">Yok</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ islem.teslim_eden or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">Henüz teslim/iade kaydı bulunmamaktadır.</div>
            {% endif %}
        </div>

        <!-- Bakım Kayıtları -->
        <div class="tab-pane fade" id="bakim">
            <div class="mb-3">
                <a href="{{ url_for('filo_bakim_ekle', arac_id=arac.id) }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Yeni Bakım Kaydı
                </a>
            </div>
            {% if bakim_kayitlari %}
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Tip</th>
                                    <th>KM</th>
                                    <th>Açıklama</th>
                                    <th>Tutar</th>
                                    <th>Servis</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bakim in bakim_kayitlari %}
                                <tr>
                                    <td>{{ bakim.bakim_tarihi }}</td>
                                    <td><span class="badge bg-info">{{ bakim.bakim_tipi }}</span></td>
                                    <td>{{ "{:,}".format(bakim.bakim_km) if bakim.bakim_km else '-' }}</td>
                                    <td>{{ bakim.aciklama }}</td>
                                    <td>{{ "{:,.2f}".format(bakim.tutar) if bakim.tutar else '-' }}</td>
                                    <td>{{ bakim.servis_adi or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">Henüz bakım kaydı bulunmamaktadır.</div>
            {% endif %}
        </div>

        <!-- Yakıt Kayıtları -->
        <div class="tab-pane fade" id="yakit">
            <div class="mb-3">
                <a href="{{ url_for('filo_yakit_ekle', arac_id=arac.id) }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Yeni Yakıt Kaydı
                </a>
            </div>
            {% if yakit_kayitlari %}
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>KM</th>
                                    <th>Litre</th>
                                    <th>Birim Fiyat</th>
                                    <th>Toplam</th>
                                    <th>İstasyon</th>
                                    <th>Çalışan</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for yakit in yakit_kayitlari %}
                                <tr>
                                    <td>{{ yakit.yakit_tarihi }}</td>
                                    <td>{{ "{:,}".format(yakit.kilometre) }}</td>
                                    <td>{{ yakit.litre }} L</td>
                                    <td>{{ "{:.2f}".format(yakit.birim_fiyat) if yakit.birim_fiyat else '-' }}</td>
                                    <td><strong>{{ "{:.2f}".format(yakit.toplam_tutar) if yakit.toplam_tutar else '-' }}</strong></td>
                                    <td>{{ yakit.istasyon or '-' }}</td>
                                    <td>{{ yakit.ad_soyad or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">Henüz yakıt kaydı bulunmamaktadır.</div>
            {% endif %}
        </div>

        <!-- Sigorta/Kaza -->
        <div class="tab-pane fade" id="sigorta">
            <div class="mb-3">
                <a href="{{ url_for('filo_sigorta_kaza_ekle', arac_id=arac.id) }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Yeni Kayıt
                </a>
            </div>
            {% if sigorta_kaza %}
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Tip</th>
                                    <th>Açıklama</th>
                                    <th>Tutar</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for kayit in sigorta_kaza %}
                                <tr>
                                    <td>{{ kayit.kayit_tarihi }}</td>
                                    <td>
                                        {% if kayit.kayit_tipi == 'Kaza' %}
                                            <span class="badge bg-danger">{{ kayit.kayit_tipi }}</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ kayit.kayit_tipi }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if kayit.kayit_tipi == 'Kaza' %}
                                            {{ kayit.kaza_aciklama or '-' }}
                                        {% else %}
                                            {{ kayit.sigorta_sirket }} - {{ kayit.police_no }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if kayit.hasar_tutari %}
                                            {{ "{:,.2f}".format(kayit.hasar_tutari) }}
                                        {% elif kayit.prim_tutari %}
                                            {{ "{:,.2f}".format(kayit.prim_tutari) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">Henüz sigorta/kaza kaydı bulunmamaktadır.</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}