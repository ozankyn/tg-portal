{% extends "base.html" %}

{% block title %}Dashboard - İK Yönetim Sistemi{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
    </div>
</div>

<!-- Genel İstatistik Kartları -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Toplam Proje</h6>
                        <h2 class="mb-0">{{ stats.toplam_proje }}</h2>
                    </div>
                    <div>
                        <i class="bi bi-folder" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Toplam Kadro</h6>
                        <h2 class="mb-0">{{ stats.toplam_kadro }}</h2>
                        <small>{{ stats.acik_kadro }} Açık / {{ stats.dolu_kadro }} Dolu</small>
                    </div>
                    <div>
                        <i class="bi bi-briefcase" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Toplam Aday</h6>
                        <h2 class="mb-0">{{ stats.toplam_aday }}</h2>
                    </div>
                    <div>
                        <i class="bi bi-person-plus" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Aktif Çalışan</h6>
                        <h2 class="mb-0">{{ stats.toplam_calisan }}</h2>
                        <small>Hedef: {{ stats.hedef_toplam }}</small>
                    </div>
                    <div>
                        <i class="bi bi-person-check" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TÜRKİYE HARİTASI - LEAFLET.JS -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-geo-alt-fill"></i> Türkiye - İl Bazında Çalışan Dağılımı</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Sol: Harita -->
                    <div class="col-lg-8">
                        <div id="turkiye-harita" style="height: 500px; border-radius: 8px;"></div>
                    </div>
                    
                    <!-- Sağ: Top 10 İller ve İstatistikler -->
                    <div class="col-lg-4">
                        <h6 class="mb-3">En Çok Çalışan Bulunan İller</h6>
                        <div class="list-group mb-3" style="max-height: 300px; overflow-y: auto;">
                            {% for il in harita_verisi|selectattr('calisan_sayisi', 'gt', 0)|sort(attribute='calisan_sayisi', reverse=true)|list|slice(10)|first %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ loop.index }}. {{ il.il_adi }}</strong>
                                    <br>
                                    <small class="text-muted">Kadro: {{ il.kadro_sayisi }} | Aday: {{ il.aday_sayisi }}</small>
                                </div>
                                <span class="badge bg-success rounded-pill" style="font-size: 1rem;">{{ il.calisan_sayisi }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <h6 class="mb-3">Coğrafi Özet</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="card bg-primary text-white text-center">
                                    <div class="card-body p-2">
                                        <h4>{{ harita_verisi|selectattr('calisan_sayisi', 'gt', 0)|list|length }}</h4>
                                        <small>Aktif İl</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-success text-white text-center">
                                    <div class="card-body p-2">
                                        <h4>{{ harita_verisi|sum(attribute='calisan_sayisi') }}</h4>
                                        <small>Çalışan</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-info text-white text-center">
                                    <div class="card-body p-2">
                                        <h4>{{ harita_verisi|sum(attribute='kadro_sayisi') }}</h4>
                                        <small>Kadro</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-warning text-dark text-center">
                                    <div class="card-body p-2">
                                        <h4>{{ harita_verisi|sum(attribute='aday_sayisi') }}</h4>
                                        <small>Aday</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3 mb-0">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                Harita üzerindeki marker'lara tıklayarak detay görebilirsiniz.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Grafikler -->
<div class="row mb-4">
    <!-- İl Bazında Dağılım -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-bar-chart-fill"></i> İl Bazında Çalışan Dağılımı (Top 10)</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="ilChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Proje Doluluk Oranları -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-pie-chart-fill"></i> Proje Bazında Doluluk Oranları</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="projeDolulukChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Aylık İşe Giriş Trendi -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Aylık İşe Giriş Trendi (Son 6 Ay)</h5>
            </div>
            <div class="card-body">
                <div style="height: 250px;">
                    <canvas id="aylikGirisChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Araç Durumu Dağılımı -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-car-front-fill"></i> Araç Durumu Dağılımı</h5>
            </div>
            <div class="card-body">
                <div style="height: 250px;">
                    <canvas id="aracChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Müdürlük Dağılımı (varsa) -->
{% if mudurluk_dagilim %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-building"></i> Müdürlük Bazında Çalışan Dağılımı</h5>
            </div>
            <div class="card-body">
                <div style="height: 200px;">
                    <canvas id="mudurlukChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Proje Kartları -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3"><i class="bi bi-folder"></i> Proje Detayları</h4>
    </div>
    {% for proje in projeler %}
    <div class="col-md-6 col-lg-4 mb-3">
        <div class="card h-100 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-folder"></i> {{ proje.proje_adi }}</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="stat-box">
                            <div class="stat-number text-info">{{ proje.toplam_kadro or 0 }}</div>
                            <div class="stat-label">Toplam Kadro</div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-box">
                            <div class="stat-number text-warning">{{ proje.toplam_aday or 0 }}</div>
                            <div class="stat-label">Toplam Aday</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-box">
                            <div class="stat-number text-success">{{ proje.toplam_calisan or 0 }}</div>
                            <div class="stat-label">Aktif Çalışan</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-box">
                            <div class="stat-number text-primary">{{ proje.toplam_hedef or 0 }}</div>
                            <div class="stat-label">Hedef</div>
                        </div>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 25px;">
                    {% set toplam_hedef = proje.toplam_hedef or 0 %}
                    {% set toplam_dolu = proje.toplam_dolu or 0 %}
                    {% set doluluk = (toplam_dolu / toplam_hedef * 100) if toplam_hedef > 0 else 0 %}
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ doluluk }}%;" 
                         aria-valuenow="{{ doluluk }}" aria-valuemin="0" aria-valuemax="100">
                        {{ "%.1f"|format(doluluk) }}% Dolu
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Kadro Detayları -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-briefcase"></i> Kadro Detayları</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Proje</th>
                                <th>Pozisyon</th>
                                <th>Lokasyon</th>
                                <th>Mağaza</th>
                                <th class="text-center">Hedef</th>
                                <th class="text-center">Dolu</th>
                                <th class="text-center">Aday</th>
                                <th class="text-center">Çalışan</th>
                                <th class="text-center">Durum</th>
                                <th>Doluluk</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for kadro in kadrolar %}
                            <tr>
                                <td><span class="badge bg-primary">{{ kadro.proje_adi }}</span></td>
                                <td><strong>{{ kadro.pozisyon_adi }}</strong></td>
                                <td>{{ kadro.il_adi }}{% if kadro.ilce_adi %} / {{ kadro.ilce_adi }}{% endif %}</td>
                                <td>{{ kadro.magaza_adi or '-' }}</td>
                                <td class="text-center"><span class="badge bg-info">{{ kadro.hedef_kisi_sayisi }}</span></td>
                                <td class="text-center"><span class="badge bg-success">{{ kadro.dolu_kisi_sayisi }}</span></td>
                                <td class="text-center"><span class="badge bg-warning text-dark">{{ kadro.aday_sayisi }}</span></td>
                                <td class="text-center"><span class="badge bg-success">{{ kadro.calisan_sayisi }}</span></td>
                                <td class="text-center">
                                    {% if kadro.durum == 'Dolu' %}
                                        <span class="badge bg-success">Dolu</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Açık</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set doluluk = (kadro.dolu_kisi_sayisi / kadro.hedef_kisi_sayisi * 100) if kadro.hedef_kisi_sayisi > 0 else 0 %}
                                    <div class="progress" style="height: 20px; min-width: 100px;">
                                        <div class="progress-bar {% if doluluk >= 100 %}bg-success{% elif doluluk >= 50 %}bg-info{% else %}bg-warning{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ doluluk }}%;" 
                                             aria-valuenow="{{ doluluk }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ "%.0f"|format(doluluk) }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="10" class="text-center text-muted">Henüz kadro eklenmemiş</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Son İşlemler -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Son İşlemler</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Tarih</th>
                                <th>İşlem</th>
                                <th>Tablo</th>
                                <th>Açıklama</th>
                                <th>Kullanıcı</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in son_islemler %}
                            <tr>
                                <td><small>{{ log.islem_tarihi }}</small></td>
                                <td>
                                    <span class="badge 
                                        {% if log.islem_tipi == 'EKLEME' %}bg-success
                                        {% elif log.islem_tipi == 'GÜNCELLEME' %}bg-info
                                        {% elif log.islem_tipi == 'DÖNÜŞÜM' %}bg-warning text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ log.islem_tipi }}
                                    </span>
                                </td>
                                <td><small>{{ log.tablo_adi }}</small></td>
                                <td>{{ log.aciklama }}</td>
                                <td><small>{{ log.kullanici }}</small></td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">Henüz işlem kaydı yok</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// HArita verisi - Jinja2'den JavaScript'e güvenli transfer
window.haritaVerisi = [
    {% for il in harita_verisi %}
    {
        il_adi: "{{ il.il_adi|replace('ı', 'i')|replace('İ', 'I')|replace('ş', 's')|replace('Ş', 'S')|replace('ğ', 'g')|replace('Ğ', 'G')|replace('ü', 'u')|replace('Ü', 'U')|replace('ö', 'o')|replace('Ö', 'O')|replace('ç', 'c')|replace('Ç', 'C') }}",
        il_adi_original: "{{ il.il_adi|escape }}",
        kadro_sayisi: {{ il.kadro_sayisi or 0 }},
        calisan_sayisi: {{ il.calisan_sayisi or 0 }},
        aday_sayisi: {{ il.aday_sayisi or 0 }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];
</script>

<script>
// Chart.js Grafikler (MEVCUT KODLARIN HEPSİ AYNEN KALACAK)

// 1. İl Bazında Çalışan Dağılımı (Bar Chart)
const ilData = {
    labels: [{% for il in il_dagilim %}'{{ il.il_adi }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
        label: 'Çalışan Sayısı',
        data: [{% for il in il_dagilim %}{{ il.calisan_sayisi }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: 'rgba(54, 162, 235, 0.8)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
    }]
};

new Chart(document.getElementById('ilChart'), {
    type: 'bar',
    data: ilData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// 2. Proje Doluluk Oranları (Doughnut Chart)
const projeData = {
    labels: [{% for proje in projeler %}'{{ proje.proje_adi }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
        label: 'Doluluk Oranı (%)',
        data: [{% for proje in projeler %}{{ "%.1f"|format((proje.toplam_dolu / proje.toplam_hedef * 100) if proje.toplam_hedef else 0) }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)'
        ],
        borderWidth: 2
    }]
};

new Chart(document.getElementById('projeDolulukChart'), {
    type: 'doughnut',
    data: projeData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});

// 3. Aylık İşe Giriş Trendi (Line Chart)
const aylikData = {
    labels: [{% for ay in aylik_giris %}'{{ ay.ay }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
        label: 'İşe Giriş Sayısı',
        data: [{% for ay in aylik_giris %}{{ ay.sayi }}{% if not loop.last %}, {% endif %}{% endfor %}],
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.4,
        fill: true
    }]
};

new Chart(document.getElementById('aylikGirisChart'), {
    type: 'line',
    data: aylikData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// 4. Araç Durumu Dağılımı (Pie Chart)
const aracData = {
    labels: [{% for arac in arac_dagilim %}'{{ arac.aracli_durum }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
        data: [{% for arac in arac_dagilim %}{{ arac.calisan_sayisi }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: [
            'rgba(40, 167, 69, 0.8)',
            'rgba(108, 117, 125, 0.8)'
        ],
        borderWidth: 2
    }]
};

new Chart(document.getElementById('aracChart'), {
    type: 'pie',
    data: aracData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// 5. Müdürlük Dağılımı (Horizontal Bar Chart)
{% if mudurluk_dagilim %}
const mudurlukData = {
    labels: [{% for m in mudurluk_dagilim %}'{{ m.mudurluk }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
        label: 'Çalışan Sayısı',
        data: [{% for m in mudurluk_dagilim %}{{ m.calisan_sayisi }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: 'rgba(153, 102, 255, 0.8)',
        borderColor: 'rgba(153, 102, 255, 1)',
        borderWidth: 1
    }]
};

new Chart(document.getElementById('mudurlukChart'), {
    type: 'bar',
    data: mudurlukData,
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
{% endif %}
</script>

<!-- YENİ: LEAFLET HARİTA -->
<script>
(function() {
    // Türkiye illeri koordinatları
    const ilKoordinatlari = {
        'Adana': [37.0, 35.3213], 'Adiyaman': [37.7648, 38.2786], 'Afyonkarahisar': [38.7507, 30.5567],
        'Agri': [39.7191, 43.0503], 'Amasya': [40.6499, 35.8353], 'Ankara': [39.9334, 32.8597],
        'Antalya': [36.8969, 30.7133], 'Artvin': [41.1828, 41.8183], 'Aydin': [37.8560, 27.8416],
        'Balikesir': [39.6484, 27.8826], 'Bilecik': [40.0567, 30.0665], 'Bingol': [39.0626, 40.7696],
        'Bitlis': [38.3938, 42.1232], 'Bolu': [40.5760, 31.5788], 'Burdur': [37.4613, 30.0665],
        'Bursa': [40.2669, 29.0634], 'Canakkale': [40.1553, 26.4142], 'Cankiri': [40.6013, 33.6134],
        'Corum': [40.5506, 34.9556], 'Denizli': [37.7765, 29.0864], 'Diyarbakir': [37.9144, 40.2306],
        'Edirne': [41.6818, 26.5623], 'Elazig': [38.6810, 39.2264], 'Erzincan': [39.7500, 39.5000],
        'Erzurum': [39.9000, 41.2700], 'Eskisehir': [39.7767, 30.5206], 'Gaziantep': [37.0662, 37.3833],
        'Giresun': [40.9128, 38.3895], 'Gumushane': [40.4386, 39.5086], 'Hakkari': [37.5833, 43.7333],
        'Hatay': [36.4018, 36.3498], 'Isparta': [37.7648, 30.5566], 'Mersin': [36.8121, 34.6415],
        'Istanbul': [41.0082, 28.9784], 'Izmir': [38.4237, 27.1428], 'Kars': [40.6167, 43.1000],
        'Kastamonu': [41.3887, 33.7827], 'Kayseri': [38.7312, 35.4787], 'Kirklareli': [41.7333, 27.2167],
        'Kirsehir': [39.1425, 34.1709], 'Kocaeli': [40.8533, 29.8815], 'Konya': [37.8667, 32.4833],
        'Kutahya': [39.4242, 29.9833], 'Malatya': [38.3552, 38.3095], 'Manisa': [38.6191, 27.4289],
        'Kahramanmaras': [37.5858, 36.9371], 'Mardin': [37.3212, 40.7245], 'Mugla': [37.2153, 28.3636],
        'Mus': [38.9462, 41.7539], 'Nevsehir': [38.6939, 34.6857], 'Nigde': [37.9667, 34.6833],
        'Ordu': [40.9839, 37.8764], 'Rize': [41.0201, 40.5234], 'Sakarya': [40.6940, 30.4358],
        'Samsun': [41.2867, 36.33], 'Siirt': [37.9333, 41.95], 'Sinop': [42.0231, 35.1531],
        'Sivas': [39.7477, 37.0179], 'Tekirdag': [40.9833, 27.5167], 'Tokat': [40.3167, 36.55],
        'Trabzon': [41.0015, 39.7178], 'Tunceli': [39.3074, 39.4388], 'Sanliurfa': [37.1591, 38.7969],
        'Usak': [38.6823, 29.4082], 'Van': [38.4891, 43.4089], 'Yozgat': [39.8181, 34.8147],
        'Zonguldak': [41.4564, 31.7987], 'Aksaray': [38.3687, 34.0370], 'Bayburt': [40.2552, 40.2249],
        'Karaman': [37.1759, 33.2287], 'Kirikkale': [39.8468, 33.5153], 'Batman': [37.8812, 41.1351],
        'Sirnak': [37.4187, 42.4918], 'Bartin': [41.5811, 32.4610], 'Ardahan': [41.1105, 42.7022],
        'Igdir': [39.8880, 44.0048], 'Yalova': [40.6500, 29.2667], 'Karabuk': [41.2061, 32.6204],
        'Kilis': [36.7184, 37.1212], 'Osmaniye': [37.2130, 36.1763], 'Duzce': [40.8438, 31.1565]
    };

    const haritaData = window.haritaVerisi;
    const map = L.map('turkiye-harita').setView([39.0, 35.0], 6);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap',
        maxZoom: 18
    }).addTo(map);
    
    const maxCalisan = Math.max(...haritaData.map(il => il.calisan_sayisi || 0));
    
    function getColor(val) {
        if (!val) return '#cccccc';
        const r = val / maxCalisan;
        if (r >= 0.8) return '#dc3545';
        if (r >= 0.5) return '#ffc107';
        if (r >= 0.2) return '#17a2b8';
        return '#28a745';
    }
    
    function getSize(val) {
        if (!val) return 8;
        return 10 + ((val / maxCalisan) * 20);
    }
    
    haritaData.forEach(il => {
        const coords = ilKoordinatlari[il.il_adi];
        if (!coords) return;
        
        const c = il.calisan_sayisi || 0;
        const marker = L.circleMarker(coords, {
            radius: getSize(c),
            fillColor: getColor(c),
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(map);
        
        marker.bindPopup(`
            <div style="min-width:200px">
                <h6><strong>${il.il_adi_original}</strong></h6>
                <table class="table table-sm mb-0">
                    <tr><td><i class="bi bi-briefcase text-info"></i> Kadro:</td><td><strong>${il.kadro_sayisi}</strong></td></tr>
                    <tr><td><i class="bi bi-person-check text-success"></i> Çalışan:</td><td><strong>${c}</strong></td></tr>
                    <tr><td><i class="bi bi-person-plus text-warning"></i> Aday:</td><td><strong>${il.aday_sayisi}</strong></td></tr>
                </table>
            </div>
        `);
        
        marker.on('mouseover', function() { this.openPopup(); });
    });
    
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'info legend');
        div.style.cssText = 'background:white;padding:10px;border-radius:5px;box-shadow:0 0 15px rgba(0,0,0,0.2)';
        div.innerHTML = `
            <div style="font-weight:bold;margin-bottom:5px">Çalışan Yoğunluğu</div>
            <div><i style="background:#dc3545;width:18px;height:18px;display:inline-block;margin-right:5px;border-radius:50%"></i>Çok Yoğun</div>
            <div><i style="background:#ffc107;width:18px;height:18px;display:inline-block;margin-right:5px;border-radius:50%"></i>Yoğun</div>
            <div><i style="background:#17a2b8;width:18px;height:18px;display:inline-block;margin-right:5px;border-radius:50%"></i>Orta</div>
            <div><i style="background:#28a745;width:18px;height:18px;display:inline-block;margin-right:5px;border-radius:50%"></i>Az</div>
            <div><i style="background:#ccc;width:18px;height:18px;display:inline-block;margin-right:5px;border-radius:50%"></i>Boş</div>
        `;
        return div;
    };
    legend.addTo(map);
})();
</script>
{% endblock %}