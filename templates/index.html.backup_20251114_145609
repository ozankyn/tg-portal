{% extends "base.html" %}

{% block title %}Dashboard - İK Yönetim Sistemi{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
    </div>
</div>

<!-- Genel İstatistik Kartları -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Toplam Proje</h6>
                        <h2 class="mb-0">{{ stats.toplam_proje }}</h2>
                    </div>
                    <div>
                        <i class="bi bi-folder" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Toplam Kadro</h6>
                        <h2 class="mb-0">{{ stats.toplam_kadro }}</h2>
                        <small>{{ stats.acik_kadro }} Açık / {{ stats.dolu_kadro }} Dolu</small>
                    </div>
                    <div>
                        <i class="bi bi-briefcase" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Toplam Aday</h6>
                        <h2 class="mb-0">{{ stats.toplam_aday }}</h2>
                    </div>
                    <div>
                        <i class="bi bi-person-plus" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Aktif Çalışan</h6>
                        <h2 class="mb-0">{{ stats.toplam_calisan }}</h2>
                        <small>Hedef: {{ stats.hedef_toplam }}</small>
                    </div>
                    <div>
                        <i class="bi bi-person-check" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- TÜRKİYE HARİTASI YERİNE: İL BAZLI DETAY HARİTASI -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-geo-alt-fill"></i> İl Bazında Detaylı Dağılım</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Sol: Top 15 İller -->
                    <div class="col-lg-6">
                        <h6 class="mb-3">En Çok Çalışan Bulunan İller</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>İl</th>
                                        <th class="text-center">Kadro</th>
                                        <th class="text-center">Çalışan</th>
                                        <th class="text-center">Aday</th>
                                        <th>Yoğunluk</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for il in harita_verisi|selectattr('calisan_sayisi', 'gt', 0)|list|slice(15)|first %}
    {% set max_calisan = harita_verisi|map(attribute='calisan_sayisi')|max %}
    {% set yogunluk = (il.calisan_sayisi / max_calisan * 100) if max_calisan > 0 else 0 %}
    <tr>
        <td><strong>{{ loop.index }}</strong></td>
        <td><strong>{{ il.il_adi }}</strong></td>
        <td class="text-center"><span class="badge bg-info">{{ il.kadro_sayisi }}</span></td>
        <td class="text-center"><span class="badge bg-success">{{ il.calisan_sayisi }}</span></td>
        <td class="text-center"><span class="badge bg-warning text-dark">{{ il.aday_sayisi }}</span></td>
        <td>
            <div class="progress" style="height: 20px; min-width: 100px;">
                <div class="progress-bar 
                    {% if yogunluk >= 80 %}bg-danger
                    {% elif yogunluk >= 50 %}bg-warning
                    {% elif yogunluk >= 20 %}bg-info
                    {% else %}bg-success{% endif %}" 
                     role="progressbar" 
                     style="width: {{ yogunluk }}%;">
                    {{ "%.0f"|format(yogunluk) }}%
                </div>
            </div>
        </td>
    </tr>
{% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Sağ: İstatistikler ve Özet -->
                    <div class="col-lg-6">
                        <h6 class="mb-3">Coğrafi Dağılım Özeti</h6>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h2>{{ harita_verisi|selectattr('calisan_sayisi', 'gt', 0)|list|length }}</h2>
                                        <small>Aktif İl Sayısı</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h2>{{ harita_verisi|sum(attribute='calisan_sayisi') }}</h2>
                                        <small>Toplam Çalışan</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h2>{{ harita_verisi|sum(attribute='kadro_sayisi') }}</h2>
                                        <small>Toplam Kadro</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body text-center">
                                        <h2>{{ harita_verisi|sum(attribute='aday_sayisi') }}</h2>
                                        <small>Toplam Aday</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="mt-4 mb-3">Bölgesel Analiz</h6>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>En Yoğun İl:</strong> 
                            {% set top_il = harita_verisi|selectattr('calisan_sayisi', 'gt', 0)|list|sort(attribute='calisan_sayisi', reverse=true)|first %}
                            {{ top_il.il_adi if top_il else '-' }} ({{ top_il.calisan_sayisi if top_il else 0 }} çalışan)
                        </div>
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Boş Kadrolu İller:</strong> 
                            {{ harita_verisi|selectattr('kadro_sayisi', 'gt', 0)|selectattr('calisan_sayisi', 'eq', 0)|list|length }} il
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Grafikler -->
<div class="row mb-4">
    <!-- İl Bazında Dağılım -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-bar-chart-fill"></i> İl Bazında Çalışan Dağılımı (Top 10)</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="ilChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Proje Doluluk Oranları -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-pie-chart-fill"></i> Proje Bazında Doluluk Oranları</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="projeDolulukChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Aylık İşe Giriş Trendi -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Aylık İşe Giriş Trendi (Son 6 Ay)</h5>
            </div>
            <div class="card-body">
                <div style="height: 250px;">
                    <canvas id="aylikGirisChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Araç Durumu Dağılımı -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-car-front-fill"></i> Araç Durumu Dağılımı</h5>
            </div>
            <div class="card-body">
                <div style="height: 250px;">
                    <canvas id="aracChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Müdürlük Dağılımı (varsa) -->
{% if mudurluk_dagilim %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-building"></i> Müdürlük Bazında Çalışan Dağılımı</h5>
            </div>
            <div class="card-body">
                <div style="height: 200px;">
                    <canvas id="mudurlukChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Proje Kartları -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3"><i class="bi bi-folder"></i> Proje Detayları</h4>
    </div>
    {% for proje in projeler %}
    <div class="col-md-6 col-lg-4 mb-3">
        <div class="card h-100 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-folder"></i> {{ proje.proje_adi }}</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="stat-box">
                            <div class="stat-number text-info">{{ proje.toplam_kadro or 0 }}</div>
                            <div class="stat-label">Toplam Kadro</div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-box">
                            <div class="stat-number text-warning">{{ proje.toplam_aday or 0 }}</div>
                            <div class="stat-label">Toplam Aday</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-box">
                            <div class="stat-number text-success">{{ proje.toplam_calisan or 0 }}</div>
                            <div class="stat-label">Aktif Çalışan</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-box">
                            <div class="stat-number text-primary">{{ proje.toplam_hedef or 0 }}</div>
                            <div class="stat-label">Hedef</div>
                        </div>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 25px;">
                    {% set toplam_hedef = proje.toplam_hedef or 0 %}
                    {% set toplam_dolu = proje.toplam_dolu or 0 %}
                    {% set doluluk = (toplam_dolu / toplam_hedef * 100) if toplam_hedef > 0 else 0 %}
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ doluluk }}%;" 
                         aria-valuenow="{{ doluluk }}" aria-valuemin="0" aria-valuemax="100">
                        {{ "%.1f"|format(doluluk) }}% Dolu
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Kadro Detayları -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-briefcase"></i> Kadro Detayları</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Proje</th>
                                <th>Pozisyon</th>
                                <th>Lokasyon</th>
                                <th>Mağaza</th>
                                <th class="text-center">Hedef</th>
                                <th class="text-center">Dolu</th>
                                <th class="text-center">Aday</th>
                                <th class="text-center">Çalışan</th>
                                <th class="text-center">Durum</th>
                                <th>Doluluk</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for kadro in kadrolar %}
                            <tr>
                                <td><span class="badge bg-primary">{{ kadro.proje_adi }}</span></td>
                                <td><strong>{{ kadro.pozisyon_adi }}</strong></td>
                                <td>{{ kadro.il_adi }}{% if kadro.ilce_adi %} / {{ kadro.ilce_adi }}{% endif %}</td>
                                <td>{{ kadro.magaza_adi or '-' }}</td>
                                <td class="text-center"><span class="badge bg-info">{{ kadro.hedef_kisi_sayisi }}</span></td>
                                <td class="text-center"><span class="badge bg-success">{{ kadro.dolu_kisi_sayisi }}</span></td>
                                <td class="text-center"><span class="badge bg-warning text-dark">{{ kadro.aday_sayisi }}</span></td>
                                <td class="text-center"><span class="badge bg-success">{{ kadro.calisan_sayisi }}</span></td>
                                <td class="text-center">
                                    {% if kadro.durum == 'Dolu' %}
                                        <span class="badge bg-success">Dolu</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Açık</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set doluluk = (kadro.dolu_kisi_sayisi / kadro.hedef_kisi_sayisi * 100) if kadro.hedef_kisi_sayisi > 0 else 0 %}
                                    <div class="progress" style="height: 20px; min-width: 100px;">
                                        <div class="progress-bar {% if doluluk >= 100 %}bg-success{% elif doluluk >= 50 %}bg-info{% else %}bg-warning{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ doluluk }}%;" 
                                             aria-valuenow="{{ doluluk }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ "%.0f"|format(doluluk) }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="10" class="text-center text-muted">Henüz kadro eklenmemiş</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Son İşlemler -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Son İşlemler</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Tarih</th>
                                <th>İşlem</th>
                                <th>Tablo</th>
                                <th>Açıklama</th>
                                <th>Kullanıcı</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in son_islemler %}
                            <tr>
                                <td><small>{{ log.islem_tarihi }}</small></td>
                                <td>
                                    <span class="badge 
                                        {% if log.islem_tipi == 'EKLEME' %}bg-success
                                        {% elif log.islem_tipi == 'GÜNCELLEME' %}bg-info
                                        {% elif log.islem_tipi == 'DÖNÜŞÜM' %}bg-warning text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ log.islem_tipi }}
                                    </span>
                                </td>
                                <td><small>{{ log.tablo_adi }}</small></td>
                                <td>{{ log.aciklama }}</td>
                                <td><small>{{ log.kullanici }}</small></td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">Henüz işlem kaydı yok</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chart.js Grafikler

// 1. İl Bazında Çalışan Dağılımı (Bar Chart)
const ilData = {
    labels: [{% for il in il_dagilim %}'{{ il.il_adi }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
        label: 'Çalışan Sayısı',
        data: [{% for il in il_dagilim %}{{ il.calisan_sayisi }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: 'rgba(54, 162, 235, 0.8)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
    }]
};

new Chart(document.getElementById('ilChart'), {
    type: 'bar',
    data: ilData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// 2. Proje Doluluk Oranları (Doughnut Chart)
const projeData = {
    labels: [{% for proje in projeler %}'{{ proje.proje_adi }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
        label: 'Doluluk Oranı (%)',
        data: [{% for proje in projeler %}{{ "%.1f"|format((proje.toplam_dolu / proje.toplam_hedef * 100) if proje.toplam_hedef else 0) }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)'
        ],
        borderWidth: 2
    }]
};

new Chart(document.getElementById('projeDolulukChart'), {
    type: 'doughnut',
    data: projeData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});

// 3. Aylık İşe Giriş Trendi (Line Chart)
const aylikData = {
    labels: [{% for ay in aylik_giris %}'{{ ay.ay }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
        label: 'İşe Giriş Sayısı',
        data: [{% for ay in aylik_giris %}{{ ay.sayi }}{% if not loop.last %}, {% endif %}{% endfor %}],
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.4,
        fill: true
    }]
};

new Chart(document.getElementById('aylikGirisChart'), {
    type: 'line',
    data: aylikData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// 4. Araç Durumu Dağılımı (Pie Chart)
const aracData = {
    labels: [{% for arac in arac_dagilim %}'{{ arac.aracli_durum }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
        data: [{% for arac in arac_dagilim %}{{ arac.calisan_sayisi }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: [
            'rgba(40, 167, 69, 0.8)',
            'rgba(108, 117, 125, 0.8)'
        ],
        borderWidth: 2
    }]
};

new Chart(document.getElementById('aracChart'), {
    type: 'pie',
    data: aracData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// 5. Müdürlük Dağılımı (Horizontal Bar Chart)
{% if mudurluk_dagilim %}
const mudurlukData = {
    labels: [{% for m in mudurluk_dagilim %}'{{ m.mudurluk }}'{% if not loop.last %}, {% endif %}{% endfor %}],
    datasets: [{
        label: 'Çalışan Sayısı',
        data: [{% for m in mudurluk_dagilim %}{{ m.calisan_sayisi }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: 'rgba(153, 102, 255, 0.8)',
        borderColor: 'rgba(153, 102, 255, 1)',
        borderWidth: 1
    }]
};

new Chart(document.getElementById('mudurlukChart'), {
    type: 'bar',
    data: mudurlukData,
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}